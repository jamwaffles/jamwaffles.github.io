<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />

  <link
    href="https://fonts.googleapis.com/css?family=Fira+Mono|Open+Sans|Oswald"
    rel="stylesheet"
  />
  <link rel="stylesheet" href="https://wapl.es/index.css" />

  <link rel="stylesheet" type="text/css" href="/syntax-theme-dark.css" media="(prefers-color-scheme: dark)" />
  <link rel="stylesheet" type="text/css" href="/syntax-theme-light.css" media="(prefers-color-scheme: light)" />
  
   
  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://wapl.es/atom.xml"> 
  <link rel="alternate" type="application/atom+xml" title="Atom" href="https://wapl.es/atom.xml"> 
  

  <title>Embedded Graphics 0.4.7 and TinyBMP 0.1.0</title>
  <meta
    name="description"
    content="Personal blog of Rust developer and hobby CNC machinist James Waples. Living in Edinburgh, Scotland ðŸ´ó §ó ¢ó ³ó £ó ´ó ¿ â¤ï¸"
  />

  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width initial-scale=1" />

  <link
    rel="apple-touch-icon"
    sizes="57x57"
    href="https://wapl.es/favicon/apple-icon-57x57.png"
  />
  <link
    rel="apple-touch-icon"
    sizes="60x60"
    href="https://wapl.es/favicon/apple-icon-60x60.png"
  />
  <link
    rel="apple-touch-icon"
    sizes="72x72"
    href="https://wapl.es/favicon/apple-icon-72x72.png"
  />
  <link
    rel="apple-touch-icon"
    sizes="76x76"
    href="https://wapl.es/favicon/apple-icon-76x76.png"
  />
  <link
    rel="apple-touch-icon"
    sizes="114x114"
    href="https://wapl.es/favicon/apple-icon-114x114.png"
  />
  <link
    rel="apple-touch-icon"
    sizes="120x120"
    href="https://wapl.es/favicon/apple-icon-120x120.png"
  />
  <link
    rel="apple-touch-icon"
    sizes="144x144"
    href="https://wapl.es/favicon/apple-icon-144x144.png"
  />
  <link
    rel="apple-touch-icon"
    sizes="152x152"
    href="https://wapl.es/favicon/apple-icon-152x152.png"
  />
  <link
    rel="apple-touch-icon"
    sizes="180x180"
    href="https://wapl.es/favicon/apple-icon-180x180.png"
  />
  <link
    rel="icon"
    type="image/png"
    sizes="192x192"
    href="https://wapl.es/favicon/android-icon-192x192.png"
  />
  <link
    rel="icon"
    type="image/png"
    sizes="32x32"
    href="https://wapl.es/favicon/favicon-32x32.png"
  />
  <link
    rel="icon"
    type="image/png"
    sizes="96x96"
    href="https://wapl.es/favicon/favicon-96x96.png"
  />
  <link
    rel="icon"
    type="image/png"
    sizes="16x16"
    href="https://wapl.es/favicon/favicon-16x16.png"
  />
  <meta name="msapplication-TileColor" content="#eeeeee" />
  <meta
    name="msapplication-TileImage"
    content="https://wapl.es/favicon/ms-icon-144x144.png"
  />
  <meta name="theme-color" content="#eeeeee" />

  <link
    rel="canonical"
    href="https:&#x2F;&#x2F;wapl.es&#x2F;rust&#x2F;2019&#x2F;03&#x2F;04&#x2F;embedded-graphics-0.4.7-bmp-support.html&#x2F;"
  />
</head>


  <body class="">
    
<div class="post__header post__header--image">
  <header class="header" role="banner">
  <div class="wrap">
    <a class="site-title" href="https:&#x2F;&#x2F;wapl.es/">
      <h1 class="header__logo">
        <img
          src="https://wapl.es/images/logo-100-circle.png"
          alt="Hello it me, James. This is a picture of a banana trifle."
        />
        <span>James Waples&#x27; Internet Hole</span>
      </h1>
    </a>

    <aside class="header__links">
      <a href="/atom.xml" class="header__links__link">
        <span class="header__links__link__text">RSS</span>
        <svg alt="RSS" xmlns="http://www.w3.org/2000/svg" viewBox="0 -256 32 32">
          <path
            d="M8.7-228.4q0 1.9-1.2 3.1-1.3 1.3-3.1 1.3-1.9 0-3.1-1.3-1.3-1.2-1.3-3 0-1.9 1.3-3.2 1.2-1.2 3-1.2 1.9 0 3.2 1.2 1.2 1.3 1.2 3.1zm11.7 2.8q0 .7-.4 1.1-.4.5-1 .5h-3.2q-.5 0-1-.4-.3-.4-.4-1-.5-5.1-4.2-8.8-3.7-3.7-8.9-4.2-.6 0-1-.5-.3-.4-.3-1v-3q0-.7.5-1 .4-.5 1-.5 3.7.3 7 1.9 3.3 1.5 6 4 2.5 2.7 4 6 1.6 3.3 1.9 7zm11.6 0q0 .7-.4 1.1-.4.5-1 .5h-3.3q-.6 0-1-.4t-.5-1q-.2-4.9-2.3-9.3-2-4.3-5.2-7.6-3.3-3.2-7.7-5.2T1.4-250q-.6 0-1-.4t-.4-1v-3.2q0-.7.5-1 .4-.5 1-.5 6 .3 11.4 2.7 5.5 2.5 9.7 6.7 4.2 4.2 6.7 9.7 2.4 5.4 2.7 11.4z"
            fill="currentColor"
          />
        </svg>
      </a>

      <a href="https://github.com/sponsors/jamwaffles" target="_blank" class="header__links__link">
        <span class="header__links__link__text">Github Sponsors</span>
        <svg
          alt="Github Sponsors"
          xmlns="http://www.w3.org/2000/svg"
          width="43.438"
          height="42.366"
          viewBox="0 0 11.493 11.209"
        >
          <path
            d="M5.746 0A5.747 5.747 0 003.93 11.2c.287.052.392-.125.392-.278 0-.136-.005-.497-.008-.977-1.598.347-1.935-.77-1.935-.77-.262-.664-.639-.841-.639-.841-.521-.356.04-.35.04-.35.577.041.88.593.88.593.513.878 1.345.625 1.673.477.052-.37.2-.624.364-.768-1.276-.145-2.617-.638-2.617-2.84 0-.627.224-1.14.591-1.542-.059-.145-.256-.73.057-1.52 0 0 .482-.155 1.58.588.458-.127.95-.19 1.438-.193.489.002.98.066 1.44.193 1.096-.743 1.578-.589 1.578-.589.313.792.116 1.376.057 1.521.369.402.59.915.59 1.542 0 2.208-1.343 2.694-2.623 2.836.206.177.39.528.39 1.064 0 .768-.007 1.388-.007 1.576 0 .154.104.333.395.277A5.749 5.749 0 005.746 0"
            fill="currentColor"
            fill-rule="evenodd"
          />
        </svg>
      </a>

      <a href="https://liberapay.com/jamwaffles/" target="_blank" class="header__links__link">
        <span class="header__links__link__text">Liberapay</span>
        <svg alt="Liberapay" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 80 80">
          <path
            d="M80 72.4c0 4.2-3.4 7.7-7.7 7.7H7.8A7.7 7.7 0 010 72.4V7.8C0 3.6 3.5.1 7.8.1h64.5c4.3 0 7.8 3.5 7.8 7.7v64.6"
            fill="currentColor"
          />
          <g fill="#fff">
            <path
              d="M32.7 56.1a15 15 0 01-6.1-1 6.5 6.5 0 01-3.2-2.7 8 8 0 01-.9-4c0-1.5.2-3.1.6-4.8l7-29 8.4-1.2-7.6 31.3-.2 1.8c0 .6 0 1 .3 1.5.2.4.6.7 1 1 .6.2 1.3.4 2.3.5L32.7 56M63.1 38.1c0 2.7-.4 5.1-1.3 7.3a16.1 16.1 0 01-9.2 9.4 18.3 18.3 0 01-10.7 1l-2.4 9.9h-8.1l9-37.7a47.6 47.6 0 0111-1.7c2.1 0 3.9.3 5.3 1a9.8 9.8 0 015.8 6.2c.4 1.5.6 3 .6 4.6M43.4 49.3l2.3.2c1.4 0 2.7-.2 3.8-.8a8.5 8.5 0 003-2.2c.8-1 1.4-2 1.9-3.4.4-1.3.7-2.8.7-4.4 0-1.5-.4-2.8-1-4-.7-1-2-1.6-3.7-1.6-1.1 0-2.2.1-3.2.4l-3.8 15.8"
            />
          </g>
        </svg>
      </a>
    </aside>

    <hr />
  </div>
</header>

</div>

<div class="post__feature-image">
  <picture>
    
    
    
    
    
    
    <source media="(min-width: 2560px)" srcset="images&#x2F;tinybmp-header.jpg" />
    <source
      media="(min-width: 1920px)"
      srcset="https:&#x2F;&#x2F;wapl.es&#x2F;processed_images&#x2F;tinybmp-header.434e3642d8ffc90b.jpg, images&#x2F;tinybmp-header.jpg 2x"
    />
    <source
      media="(min-width: 1600px)"
      srcset="https:&#x2F;&#x2F;wapl.es&#x2F;processed_images&#x2F;tinybmp-header.700f6eddef64c28a.jpg, images&#x2F;tinybmp-header.jpg 2x"
    />
    <source
      media="(min-width: 1280px)"
      srcset="https:&#x2F;&#x2F;wapl.es&#x2F;processed_images&#x2F;tinybmp-header.666a7c02ccd1c645.jpg, images&#x2F;tinybmp-header.jpg 2x"
    />
    <source
      media="(min-width: 960px)"
      srcset="https:&#x2F;&#x2F;wapl.es&#x2F;processed_images&#x2F;tinybmp-header.20d8fc5e41fc6747.jpg, https:&#x2F;&#x2F;wapl.es&#x2F;processed_images&#x2F;tinybmp-header.434e3642d8ffc90b.jpg 2x"
    />
    <source
      media="(min-width: 800px)"
      srcset="https:&#x2F;&#x2F;wapl.es&#x2F;processed_images&#x2F;tinybmp-header.056f0b402dac52e6.jpg, https:&#x2F;&#x2F;wapl.es&#x2F;processed_images&#x2F;tinybmp-header.700f6eddef64c28a.jpg 2x"
    />
    <source
      media="(max-width: 640px)"
      srcset="https:&#x2F;&#x2F;wapl.es&#x2F;processed_images&#x2F;tinybmp-header.7403dfa01da97804.jpg, https:&#x2F;&#x2F;wapl.es&#x2F;processed_images&#x2F;tinybmp-header.666a7c02ccd1c645.jpg 2x"
    />
    <img
      class="post__feature-image__inner"
      src="images&#x2F;tinybmp-header.jpg"
      alt="Blog post header image decoration."
    />
  </picture>
</div>


<article role="main" class="post image">
  <header>
    <a href="https:&#x2F;&#x2F;wapl.es" id="home_link">Â« Posts list</a>
    <div class="post__title">
      <h1>Embedded Graphics 0.4.7 and TinyBMP 0.1.0</h1>

      <time datetime="2019-03-04"
        ><a href="https:&#x2F;&#x2F;wapl.es&#x2F;rust&#x2F;2019&#x2F;03&#x2F;04&#x2F;embedded-graphics-0.4.7-bmp-support.html&#x2F;">March 04, 2019</a></time
      >
    </div>
  </header>

  <div class="post__text" id="js-post-content"><p><a href="https://crates.io/crates/embedded-graphics">Embedded graphics</a> 0.4.7 has been released, along with
a new sister crate, <a href="https://crates.io/crates/tinybmp">tinybmp</a>! TinyBMP aims to parse BMP-format
image data using no dynamic allocations. It targets embedded environments but can be used in any
place a small BMP parser is required. Thanks to TinyBMP, Embedded Graphics now supports loading this
simple image format. The header photo was made using Embedded Graphics and the
<a href="https://crates.io/crates/ssd1331">SSD1331 driver</a> in pure Rust. In this post, I'll talk through how
the BMP file is parsed in no_std environments with <a href="https://crates.io/crates/nom">nom</a> and how to
get BMP images working with embedded_graphics.</p>
<h2 id="bmp-format">BMP format</h2>
<p>The BMP format is pretty simple. It consists of the following sections which I'll cover separately
below:</p>
<ul>
<li>File header (metadata)</li>
<li>DIB header (more metadata)</li>
<li>Colour pallette table (for colour-indexed images, ignored by TinyBMP)</li>
<li>Bitmap information</li>
</ul>
<h3 id="file-header-and-dib-header">File header and DIB header</h3>
<p>I'm not sure why the header is split into two parts, but TinyBMP treats them as a single section as
they form a contiguous block of bytes in the file. The parser ignores some extraneous fields in the
header. The ones we're interested in are described in the
<a href="https://docs.rs/tinybmp/0.1.0/tinybmp/struct.Header.html"><code>Header</code></a> struct:</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> BMP header information
</span><span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">derive</span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust">Debug<span class="z-punctuation z-separator z-rust">,</span> Clone<span class="z-punctuation z-separator z-rust">,</span> PartialEq</span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
<span class="z-meta z-struct z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-struct z-rust">struct</span> </span><span class="z-meta z-struct z-rust"><span class="z-entity z-name z-struct z-rust">Header</span> </span><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> Bitmap file type
</span>    <span class="z-storage z-modifier z-rust">pub</span> <span class="z-variable z-other z-member z-rust">file_type</span><span class="z-punctuation z-separator z-type z-rust">:</span> FileType,
    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> Total file size in bytes
</span>    <span class="z-storage z-modifier z-rust">pub</span> <span class="z-variable z-other z-member z-rust">file_size</span><span class="z-punctuation z-separator z-type z-rust">:</span> <span class="z-storage z-type z-rust">u32</span>,
    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> Reserved field 1 (unused)
</span>    <span class="z-storage z-modifier z-rust">pub</span> <span class="z-variable z-other z-member z-rust">reserved_1</span><span class="z-punctuation z-separator z-type z-rust">:</span> <span class="z-storage z-type z-rust">u16</span>,
    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> Reserved field 2 (unused)
</span>    <span class="z-storage z-modifier z-rust">pub</span> <span class="z-variable z-other z-member z-rust">reserved_2</span><span class="z-punctuation z-separator z-type z-rust">:</span> <span class="z-storage z-type z-rust">u16</span>,
    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> Byte offset from beginning of file at which pixel data begins
</span>    <span class="z-storage z-modifier z-rust">pub</span> <span class="z-variable z-other z-member z-rust">image_data_start</span><span class="z-punctuation z-separator z-type z-rust">:</span> <span class="z-storage z-type z-rust">usize</span>,
    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> Image width in pixels
</span>    <span class="z-storage z-modifier z-rust">pub</span> <span class="z-variable z-other z-member z-rust">image_width</span><span class="z-punctuation z-separator z-type z-rust">:</span> <span class="z-storage z-type z-rust">u32</span>,
    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> Image height in pixels
</span>    <span class="z-storage z-modifier z-rust">pub</span> <span class="z-variable z-other z-member z-rust">image_height</span><span class="z-punctuation z-separator z-type z-rust">:</span> <span class="z-storage z-type z-rust">u32</span>,
    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> Number of bits per pixel
</span>    <span class="z-storage z-modifier z-rust">pub</span> <span class="z-variable z-other z-member z-rust">bpp</span><span class="z-punctuation z-separator z-type z-rust">:</span> <span class="z-storage z-type z-rust">u16</span>,
    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> Length in bytes of the image data
</span>    <span class="z-storage z-modifier z-rust">pub</span> <span class="z-variable z-other z-member z-rust">image_data_len</span><span class="z-punctuation z-separator z-type z-rust">:</span> <span class="z-storage z-type z-rust">u32</span>,
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre>
<p>There are some other fields present in the header segments, but they're not important for bitmap
parsing.</p>
<p>To parse this header, I'm using <a href="https://crates.io/crates/nom">nom</a> (a parser-combinator library) in
no_std mode. It's defined in TinyBMP's <code>Cargo.toml</code> like this:</p>
<pre data-lang="toml" class="language-toml z-code"><code class="language-toml" data-lang="toml"><span class="z-source z-toml"><span class="z-punctuation z-definition z-table z-begin z-toml">[</span><span class="z-meta z-tag z-table z-toml"><span class="z-entity z-name z-table z-toml">dependencies</span><span class="z-punctuation z-separator z-table z-toml">.</span><span class="z-entity z-name z-table z-toml">nom</span></span><span class="z-punctuation z-definition z-table z-end z-toml">]</span>
<span class="z-meta z-tag z-key z-toml"><span class="z-entity z-name z-tag z-toml">version</span></span> <span class="z-punctuation z-definition z-key-value z-toml">=</span> <span class="z-string z-quoted z-double z-basic z-toml"><span class="z-punctuation z-definition z-string z-begin z-toml">&quot;</span>4.2.1<span class="z-punctuation z-definition z-string z-end z-toml">&quot;</span></span>
<span class="z-meta z-tag z-key z-toml"><span class="z-entity z-name z-tag z-toml">default-features</span></span> <span class="z-punctuation z-definition z-key-value z-toml">=</span> <span class="z-constant z-language z-toml">false</span>
</span></code></pre>
<p>The parser is pretty simple. BMP data is little-endian encoded, so we can use Nom's <code>le_u16</code> and
<code>le_u32</code> to parse all the fields out with a function called <code>parse_header</code>:</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-support z-macro z-rust">named!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-generic z-rust">parse_header<span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-keyword z-operator z-rust">&amp;</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-storage z-type z-rust">u8</span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>, Header<span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span><span class="z-punctuation z-separator z-rust">,</span>
    <span class="z-support z-macro z-rust">do_parse!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>
        <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> &quot;Magic bytes&quot; marker for BMP files
</span>        <span class="z-support z-macro z-rust">tag!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&quot;</span>BM<span class="z-punctuation z-definition z-string z-end z-rust">&quot;</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-comparison z-rust">&gt;</span><span class="z-keyword z-operator z-comparison z-rust">&gt;</span>
        file_size<span class="z-punctuation z-separator z-rust">:</span> le_u32 <span class="z-keyword z-operator z-comparison z-rust">&gt;</span><span class="z-keyword z-operator z-comparison z-rust">&gt;</span>
        reserved_1<span class="z-punctuation z-separator z-rust">:</span> le_u16 <span class="z-keyword z-operator z-comparison z-rust">&gt;</span><span class="z-keyword z-operator z-comparison z-rust">&gt;</span>
        reserved_2<span class="z-punctuation z-separator z-rust">:</span> le_u16 <span class="z-keyword z-operator z-comparison z-rust">&gt;</span><span class="z-keyword z-operator z-comparison z-rust">&gt;</span>
        image_data_start<span class="z-punctuation z-separator z-rust">:</span> le_u32 <span class="z-keyword z-operator z-comparison z-rust">&gt;</span><span class="z-keyword z-operator z-comparison z-rust">&gt;</span>
        <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Skip 4 bytes: Remaining header length in bytes
</span>        le_u32 <span class="z-keyword z-operator z-comparison z-rust">&gt;</span><span class="z-keyword z-operator z-comparison z-rust">&gt;</span>
        image_width<span class="z-punctuation z-separator z-rust">:</span> le_u32 <span class="z-keyword z-operator z-comparison z-rust">&gt;</span><span class="z-keyword z-operator z-comparison z-rust">&gt;</span>
        image_height<span class="z-punctuation z-separator z-rust">:</span> le_u32 <span class="z-keyword z-operator z-comparison z-rust">&gt;</span><span class="z-keyword z-operator z-comparison z-rust">&gt;</span>
        <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Skip 4 bytes: Number of color planes
</span>        le_u16 <span class="z-keyword z-operator z-comparison z-rust">&gt;</span><span class="z-keyword z-operator z-comparison z-rust">&gt;</span>
        bpp<span class="z-punctuation z-separator z-rust">:</span> le_u16 <span class="z-keyword z-operator z-comparison z-rust">&gt;</span><span class="z-keyword z-operator z-comparison z-rust">&gt;</span>
        <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Skip 4 bytes: Compression method used
</span>        le_u32 <span class="z-keyword z-operator z-comparison z-rust">&gt;</span><span class="z-keyword z-operator z-comparison z-rust">&gt;</span>
        image_data_len<span class="z-punctuation z-separator z-rust">:</span> le_u32 <span class="z-keyword z-operator z-comparison z-rust">&gt;</span><span class="z-keyword z-operator z-comparison z-rust">&gt;</span>
        <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Skip other fields here
</span>        <span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>Header<span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
            file_type<span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-path z-rust">FileType<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-constant z-other z-rust">BM</span><span class="z-punctuation z-separator z-rust">,</span>
            file_size<span class="z-punctuation z-separator z-rust">,</span>
            reserved_1<span class="z-punctuation z-separator z-rust">,</span>
            reserved_2<span class="z-punctuation z-separator z-rust">,</span>
            image_data_start<span class="z-punctuation z-separator z-rust">:</span> image_data_start <span class="z-keyword z-operator z-rust">as</span> <span class="z-storage z-type z-rust">usize</span><span class="z-punctuation z-separator z-rust">,</span>
            image_width<span class="z-punctuation z-separator z-rust">,</span>
            image_height<span class="z-punctuation z-separator z-rust">,</span>
            image_data_len<span class="z-punctuation z-separator z-rust">,</span>
            bpp
        </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
    </span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></code></pre>
<p>This takes a slice (<code>&amp;[u8]</code>) and produces a <code>Header</code> struct from the first few bytes of it. It
should be pretty self explanatory, but I'll address some odd parts of the code above.</p>
<ul>
<li><code>tag!(&quot;BM&quot;)</code> This is the &quot;magic bytes&quot; <code>BM</code> marker for BMP files, and must be present for the BMP
to be valid.</li>
<li>Lines with a lonesome <code>le_u16</code> or <code>le_u32</code> simply skip ahead 2 or 4 bytes respectively. This will
be a field in the header that we want to ignore.</li>
</ul>
<p>The <code>Header</code> struct is all we need to parse from the BMP file to be able to use it. On 32 bit
systems (i.e. ARM MCUs, other embedded devices), <code>Header</code> only
<a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=f17e0aabe4f1471f22a34a7bf9426ad3">requires 28 bytes of RAM</a>.
Nice!</p>
<h3 id="bitmap-information">Bitmap information</h3>
<p>BMP pixel data is pretty unremarkable, the only caveat being that the Y values are inverted, with
the bottom row at the start of the data. Pixel values are stored in little-endian order in whatever
bit depth is specified in the header. This will commonly be 32 or 24 bits, but 16, 8 or even 1BPP is
supported by the BMP format. <strong>Currently, only 8 and 16 BPP images are supported by Embedded
Graphics. If you'd like to see other bit-depths supported, please
<a href="https://github.com/jamwaffles/embedded-graphics/issues/new">open an issue</a>!</strong></p>
<h2 id="containing-everything">Containing everything</h2>
<p>The other data type exported by TinyBMP is the
<a href="https://docs.rs/tinybmp/0.1.0/tinybmp/struct.Bmp.html"><code>Bmp</code></a> struct:</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> A BMP-format bitmap
</span><span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">derive</span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust">Debug<span class="z-punctuation z-separator z-rust">,</span> Clone<span class="z-punctuation z-separator z-rust">,</span> PartialEq</span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
<span class="z-meta z-struct z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-struct z-rust">struct</span> </span><span class="z-meta z-struct z-rust"><span class="z-meta z-generic z-rust"><span class="z-entity z-name z-struct z-rust">Bmp</span><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-storage z-modifier z-lifetime z-rust">&#39;a</span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span></span></span><span class="z-meta z-struct z-rust"> </span><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> Image header
</span>    <span class="z-storage z-modifier z-rust">pub</span> <span class="z-variable z-other z-member z-rust">header</span><span class="z-punctuation z-separator z-type z-rust">:</span> Header,

    <span class="z-variable z-other z-member z-rust">image_data</span><span class="z-punctuation z-separator z-type z-rust">:</span> <span class="z-keyword z-operator z-rust">&amp;</span><span class="z-storage z-modifier z-lifetime z-rust">&#39;a</span> [<span class="z-storage z-type z-rust">u8</span>],
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre>
<p>This is how you should use TinyBMP, namely with the
<a href="https://docs.rs/tinybmp/0.1.0/tinybmp/struct.Bmp.html#method.from_slice"><code>from_slice</code></a> method:</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> Create a bitmap object from a byte array
</span><span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span>
</span><span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> This method keeps a slice of the original input and does not dynamically allocate memory.
</span><span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> The input data must live for as long as this BMP instance does.
</span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">from_slice</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-variable z-parameter z-rust">bytes</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-rust">&amp;</span><span class="z-storage z-modifier z-lifetime z-rust">&#39;a</span> [<span class="z-storage z-type z-rust">u8</span>]</span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-&gt;</span> <span class="z-meta z-generic z-rust"><span class="z-support z-type z-rust">Result</span><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-storage z-type z-rust">Self</span>, <span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-punctuation z-section z-group z-end z-rust">)</span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span></span> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    <span class="z-storage z-type z-rust">let</span> <span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>_remaining<span class="z-punctuation z-separator z-rust">,</span> header</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-support z-function z-rust">parse_header</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>bytes</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">map_err</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">|</span></span></span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust">_<span class="z-punctuation z-section z-parameters z-end z-rust">|</span></span> </span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-keyword z-operator z-rust">?</span><span class="z-punctuation z-terminator z-rust">;</span>

    <span class="z-storage z-type z-rust">let</span> image_data <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-keyword z-operator z-bitwise z-rust">&amp;</span>bytes<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span>header<span class="z-punctuation z-accessor z-dot z-rust">.</span>image_data_start<span class="z-keyword z-operator z-range z-rust">..</span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span><span class="z-punctuation z-terminator z-rust">;</span>

    <span class="z-support z-type z-rust">Ok</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>Bmp <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span> header<span class="z-punctuation z-separator z-rust">,</span> image_data </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre>
<p>This method takes a slice representing a complete BMP file and creates a <code>Bmp</code> from it. The header
is parsed and a sub-slice of the input data is kept in the <code>image_data</code> field, based on the
<code>image_data_start</code> field from the header.</p>
<p>Keeping with the no_std, low-memory-usage theme,
<a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=441d59cefe15b51ba0efd57887f329f6"><code>Bmp</code> only consumes 48 bytes of memory</a>!
Bear in mind the playground uses 64 bit Rust (I think), so memory usage on a 32 bit ARM
microcontroller might even be a bit less. The original bitmap data must be kept somewhere of course,
but this works well with <code>include_bytes!()</code> in and embedded context; <code>include_bytes!()</code> data is kept
in flash memory, leaving precious RAM available for your application. Microcontrollers generally
have a lot more flash than RAM, so it's sensible to store large byte arrays in flash.</p>
<h2 id="embedded-graphics">Embedded Graphics</h2>
<p>TinyBMP exposes BMP image data through the
<a href="https://docs.rs/tinybmp/0.1.0/tinybmp/struct.Bmp.html#method.image_data"><code>image_data()</code></a> method on
<code>Bmp</code>. We can use this image data to form an <code>Image</code> iterator for Embedded Graphics to use.</p>
<h3 id="the-struct">The struct</h3>
<p>First, let's define <code>ImageBmp</code> that wraps a <code>Bmp</code> file with some extra data to allow for cool
Embedded Graphics things like transforms:</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> BMP format image
</span><span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">derive</span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust">Debug<span class="z-punctuation z-separator z-rust">,</span> Clone</span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
<span class="z-meta z-struct z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-struct z-rust">struct</span> </span><span class="z-meta z-struct z-rust"><span class="z-meta z-generic z-rust"><span class="z-entity z-name z-struct z-rust">ImageBmp</span><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-storage z-modifier z-lifetime z-rust">&#39;a</span>, C<span class="z-punctuation z-separator z-rust">:</span> PixelColor<span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span></span></span><span class="z-meta z-struct z-rust"> </span><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    <span class="z-variable z-other z-member z-rust">bmp</span><span class="z-punctuation z-separator z-type z-rust">:</span> <span class="z-meta z-generic z-rust">Bmp<span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-storage z-modifier z-lifetime z-rust">&#39;a</span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span>,

    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> Top left corner offset from display origin (0,0)
</span>    <span class="z-storage z-modifier z-rust">pub</span> <span class="z-variable z-other z-member z-rust">offset</span><span class="z-punctuation z-separator z-type z-rust">:</span> Coord,

    <span class="z-variable z-other z-member z-rust">pixel_type</span><span class="z-punctuation z-separator z-type z-rust">:</span> <span class="z-meta z-generic z-rust">PhantomData<span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span>C<span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span>,
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre>
<p><code>PixelColor</code> will be used a bit later to make <code>ImageBmp</code> compatible with multiple pixel types.</p>
<p>You can read the entire source for <code>ImageBmp</code>
<a href="https://github.com/jamwaffles/embedded-graphics/blob/10b9aacb668b732863a66fa5fcd055dfb2f72eba/embedded-graphics/src/image/image_bmp.rs">here</a>.
I'll only cover some parts of it to keep this post to a reasonable length.</p>
<h3 id="iterator-setup">Iterator setup</h3>
<p>Now we have an <code>ImageBmp</code>, we need to get an iterator for it so the pixel data can be used by
Embedded Graphics-compatible libraries. This can be done by creating <code>ImageBmpIterator</code> and
implementing <code>IntoIterator for ImageBmp</code>:</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">derive</span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust">Debug</span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
<span class="z-meta z-struct z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-struct z-rust">struct</span> </span><span class="z-meta z-struct z-rust"><span class="z-meta z-generic z-rust"><span class="z-entity z-name z-struct z-rust">ImageBmpIterator</span><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-storage z-modifier z-lifetime z-rust">&#39;a</span>, C<span class="z-punctuation z-separator z-rust">:</span> <span class="z-storage z-modifier z-lifetime z-rust">&#39;a</span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span></span></span><span class="z-meta z-struct z-rust">
where
    C: PixelColor,
</span><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    <span class="z-variable z-other z-member z-rust">x</span><span class="z-punctuation z-separator z-type z-rust">:</span> <span class="z-storage z-type z-rust">u32</span>,
    <span class="z-variable z-other z-member z-rust">y</span><span class="z-punctuation z-separator z-type z-rust">:</span> <span class="z-storage z-type z-rust">u32</span>,
    <span class="z-variable z-other z-member z-rust">im</span><span class="z-punctuation z-separator z-type z-rust">:</span> <span class="z-keyword z-operator z-rust">&amp;</span><span class="z-storage z-modifier z-lifetime z-rust">&#39;a</span> <span class="z-meta z-generic z-rust">ImageBmp<span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-storage z-modifier z-lifetime z-rust">&#39;a</span>, C<span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span>,
    <span class="z-variable z-other z-member z-rust">image_data</span><span class="z-punctuation z-separator z-type z-rust">:</span> <span class="z-keyword z-operator z-rust">&amp;</span><span class="z-storage z-modifier z-lifetime z-rust">&#39;a</span> [<span class="z-storage z-type z-rust">u8</span>],
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>

<span class="z-meta z-impl z-rust"><span class="z-storage z-type z-impl z-rust">impl</span></span><span class="z-meta z-impl z-rust"><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-storage z-modifier z-lifetime z-rust">&#39;a</span>, C<span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span></span><span class="z-meta z-impl z-rust"> IntoIterator <span class="z-keyword z-other z-rust">for</span></span><span class="z-meta z-impl z-rust"> <span class="z-keyword z-operator z-rust">&amp;</span><span class="z-storage z-modifier z-lifetime z-rust">&#39;a</span> <span class="z-entity z-name z-impl z-rust">ImageBmp</span><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-storage z-modifier z-lifetime z-rust">&#39;a</span>, C<span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span>
</span><span class="z-meta z-impl z-rust"><span class="z-keyword z-other z-rust">where</span>
    C<span class="z-punctuation z-separator z-rust">:</span> PixelColor + <span class="z-meta z-generic z-rust"><span class="z-support z-type z-rust">From</span><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-storage z-type z-rust">u8</span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span> + <span class="z-meta z-generic z-rust"><span class="z-support z-type z-rust">From</span><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-storage z-type z-rust">u16</span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span>,
</span><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    <span class="z-storage z-type z-type z-rust">type</span> <span class="z-entity z-name z-type z-rust">Item</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-generic z-rust">Pixel<span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span>C<span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span><span class="z-punctuation z-terminator z-rust">;</span>
    <span class="z-storage z-type z-type z-rust">type</span> <span class="z-entity z-name z-type z-rust">IntoIter</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-generic z-rust">ImageBmpIterator<span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-storage z-modifier z-lifetime z-rust">&#39;a</span>, C<span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span><span class="z-punctuation z-terminator z-rust">;</span>

    <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">into_iter</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-variable z-parameter z-rust">self</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-&gt;</span> <span class="z-meta z-path z-rust"><span class="z-storage z-type z-rust"><span class="z-storage z-type z-rust">Self</span><span class="z-punctuation z-accessor z-rust">::</span></span></span>IntoIter</span> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
        ImageBmpIterator <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
            im<span class="z-punctuation z-separator z-rust">:</span> <span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-separator z-rust">,</span>
            image_data<span class="z-punctuation z-separator z-rust">:</span> <span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span>bmp<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">image_data</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span>
            x<span class="z-punctuation z-separator z-rust">:</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">0</span><span class="z-punctuation z-separator z-rust">,</span>
            y<span class="z-punctuation z-separator z-rust">:</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">0</span><span class="z-punctuation z-separator z-rust">,</span>
        </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre>
<p><code>image_data</code> uses the <code>Bmp::image_data()</code> method mentioned above. Note that everything uses
<em>references to the original data</em>, meaning <strong>no new allocations of huge amounts of pixel data.</strong></p>
<p>I'm also adding <code>From&lt;u8&gt; + From&lt;u16&gt;</code> as trait bounds for reasons that will become clear in the
next section.</p>
<h3 id="the-iterator">The iterator</h3>
<p>This is the most important part of the compatibility between Embedded Graphics and TinyBMP - the
iterator implementation. It's responsible for iterating over the BMP pixel data correctly (remember
that it starts from the bottom up) as well as converting 8 or 16 bit words into the correct
<code>PixelColor*</code>. This is what it looks like:</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-storage z-type z-impl z-rust">impl</span></span><span class="z-meta z-impl z-rust"><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-storage z-modifier z-lifetime z-rust">&#39;a</span>, C<span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span></span><span class="z-meta z-impl z-rust"> Iterator <span class="z-keyword z-other z-rust">for</span></span><span class="z-meta z-impl z-rust"> <span class="z-entity z-name z-impl z-rust">ImageBmpIterator</span><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-storage z-modifier z-lifetime z-rust">&#39;a</span>, C<span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span>
</span><span class="z-meta z-impl z-rust"><span class="z-keyword z-other z-rust">where</span>
    C<span class="z-punctuation z-separator z-rust">:</span> PixelColor + <span class="z-meta z-generic z-rust"><span class="z-support z-type z-rust">From</span><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-storage z-type z-rust">u8</span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span> + <span class="z-meta z-generic z-rust"><span class="z-support z-type z-rust">From</span><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-storage z-type z-rust">u16</span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span>,
</span><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    <span class="z-storage z-type z-type z-rust">type</span> <span class="z-entity z-name z-type z-rust">Item</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-generic z-rust">Pixel<span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span>C<span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span><span class="z-punctuation z-terminator z-rust">;</span>

    <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">next</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-keyword z-operator z-rust">&amp;</span><span class="z-storage z-modifier z-rust">mut</span> <span class="z-variable z-parameter z-rust">self</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-&gt;</span> <span class="z-meta z-generic z-rust"><span class="z-support z-type z-rust">Option</span><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-meta z-path z-rust"><span class="z-storage z-type z-rust"><span class="z-storage z-type z-rust">Self</span><span class="z-punctuation z-accessor z-rust">::</span></span></span>Item<span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span></span> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
        <span class="z-storage z-type z-rust">let</span> current_pixel <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-keyword z-control z-rust">loop</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
            <span class="z-storage z-type z-rust">let</span> w <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span>im<span class="z-punctuation z-accessor z-dot z-rust">.</span>bmp<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">width</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
            <span class="z-storage z-type z-rust">let</span> h <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span>im<span class="z-punctuation z-accessor z-dot z-rust">.</span>bmp<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">height</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
            <span class="z-storage z-type z-rust">let</span> x <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span>x<span class="z-punctuation z-terminator z-rust">;</span>
            <span class="z-storage z-type z-rust">let</span> y <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span>y<span class="z-punctuation z-terminator z-rust">;</span>

            <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> End iterator if we&#39;ve run out of stuff
</span>            <span class="z-keyword z-control z-rust">if</span> x <span class="z-keyword z-operator z-comparison z-rust">&gt;=</span> w <span class="z-keyword z-operator z-logical z-rust">||</span> y <span class="z-keyword z-operator z-comparison z-rust">&gt;=</span> h <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
                <span class="z-keyword z-control z-rust">return</span> <span class="z-support z-type z-rust">None</span><span class="z-punctuation z-terminator z-rust">;</span>
            </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>

            <span class="z-storage z-type z-rust">let</span> offset <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>h <span class="z-keyword z-operator z-arithmetic z-rust">-</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">1</span> <span class="z-keyword z-operator z-arithmetic z-rust">-</span> y</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-arithmetic z-rust">*</span> w</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-arithmetic z-rust">+</span> x<span class="z-punctuation z-terminator z-rust">;</span>

            <span class="z-storage z-type z-rust">let</span> bit_value <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-keyword z-control z-rust">if</span> <span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span>im<span class="z-punctuation z-accessor z-dot z-rust">.</span>bmp<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">bpp</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-comparison z-rust">==</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">8</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
                <span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span>image_data<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span>offset <span class="z-keyword z-operator z-rust">as</span> <span class="z-storage z-type z-rust">usize</span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span> <span class="z-keyword z-operator z-rust">as</span> <span class="z-storage z-type z-rust">u16</span>
            </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span> <span class="z-keyword z-control z-rust">else</span> <span class="z-keyword z-control z-rust">if</span> <span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span>im<span class="z-punctuation z-accessor z-dot z-rust">.</span>bmp<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">bpp</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-comparison z-rust">==</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">16</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
                <span class="z-storage z-type z-rust">let</span> offset <span class="z-keyword z-operator z-assignment z-rust">=</span> offset <span class="z-keyword z-operator z-arithmetic z-rust">*</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">2</span><span class="z-punctuation z-terminator z-rust">;</span> <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> * 2 as two bytes per pixel
</span>
                <span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span>image_data<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span>offset <span class="z-keyword z-operator z-rust">as</span> <span class="z-storage z-type z-rust">usize</span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span> <span class="z-keyword z-operator z-rust">as</span> <span class="z-storage z-type z-rust">u16</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
                    <span class="z-keyword z-operator z-bitwise z-rust">|</span> <span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span>image_data<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>offset <span class="z-keyword z-operator z-arithmetic z-rust">+</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">1</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-rust">as</span> <span class="z-storage z-type z-rust">usize</span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span> <span class="z-keyword z-operator z-rust">as</span> <span class="z-storage z-type z-rust">u16</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-comparison z-rust">&lt;</span><span class="z-keyword z-operator z-comparison z-rust">&lt;</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">8</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
            </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span> <span class="z-keyword z-control z-rust">else</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
                <span class="z-support z-macro z-rust">panic!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&quot;</span>Bit depth {} not supported<span class="z-punctuation z-definition z-string z-end z-rust">&quot;</span></span><span class="z-punctuation z-separator z-rust">,</span> <span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span>im<span class="z-punctuation z-accessor z-dot z-rust">.</span>bmp<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">bpp</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
            </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span><span class="z-punctuation z-terminator z-rust">;</span>

            <span class="z-storage z-type z-rust">let</span> current_pixel <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span>im<span class="z-punctuation z-accessor z-dot z-rust">.</span>offset <span class="z-keyword z-operator z-arithmetic z-rust">+</span> <span class="z-meta z-path z-rust">Coord<span class="z-punctuation z-accessor z-rust">::</span></span>new<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>x <span class="z-keyword z-operator z-rust">as</span> <span class="z-storage z-type z-rust">i32</span><span class="z-punctuation z-separator z-rust">,</span> y <span class="z-keyword z-operator z-rust">as</span> <span class="z-storage z-type z-rust">i32</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>

            <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Increment stuff
</span>            <span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span>x <span class="z-keyword z-operator z-assignment z-rust">+=</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">1</span><span class="z-punctuation z-terminator z-rust">;</span>

            <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Step down a row if we&#39;ve hit the end of this one
</span>            <span class="z-keyword z-control z-rust">if</span> <span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span>x <span class="z-keyword z-operator z-comparison z-rust">&gt;=</span> w <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
                <span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span>x <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">0</span><span class="z-punctuation z-terminator z-rust">;</span>
                <span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span>y <span class="z-keyword z-operator z-assignment z-rust">+=</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">1</span><span class="z-punctuation z-terminator z-rust">;</span>
            </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>

            <span class="z-keyword z-control z-rust">if</span> current_pixel<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-constant z-numeric z-integer z-decimal z-rust">0</span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span> <span class="z-keyword z-operator z-comparison z-rust">&gt;=</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">0</span> <span class="z-keyword z-operator z-logical z-rust">&amp;&amp;</span> current_pixel<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-constant z-numeric z-integer z-decimal z-rust">1</span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span> <span class="z-keyword z-operator z-comparison z-rust">&gt;=</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">0</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
                <span class="z-keyword z-control z-rust">break</span> Pixel<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>current_pixel<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">to_unsigned</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span> bit_value<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">into</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
            </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
        </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span><span class="z-punctuation z-terminator z-rust">;</span>

        <span class="z-support z-type z-rust">Some</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>current_pixel</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre>
<p>(it could probably stand to be optimised a bit. PRs welcome!)</p>
<p>This function is responsible for stepping through <em>on screen</em> pixels; a translation may put some of
the image off the top left corner of the screen, so those pixels must be skipped. This is why most
of the function body is wrapped in a <code>loop</code>.</p>
<p>For each pixel coordinate, either 1 (for 8BPP) or two (for 16BPP) bytes are taken from the image
data and cast to a <code>u16</code>.</p>
<p>If the pixel has positive coordinates, it's position and colour are returned. This is where the
<code>From&lt;u8&gt; + From&lt;u16&gt;</code> bounds come in - they allow <code>bit_value.into()</code> to cast the pixel value into
the correct <code>PixelColor*</code> used in calling code. I'll explain that better in the next section.</p>
<h2 id="an-example">An example</h2>
<p>Let's walk through some of the steps to display this image on an embedded display:</p>
<p><img src="/images/rust-bmp-large.jpg" alt="Rust logo with rainbow." /></p>
<p>The <a href="https://crates.io/crates/ssd1331">SSD1331 crate</a> uses the new TinyBMP support in Embedded
Graphics to draw colour images like the one in the header for this post. The SSD1331 is a 16 bit
colour display. It requires pixel data to be sent to it as 16 bit words split into 5 red, 6 green
and 5 blue colour bits. This works nicely as we can use
<a href="https://docs.rs/embedded-graphics/0.4.7/embedded_graphics/pixelcolor/struct.PixelColorU16.html"><code>PixelColorU16</code></a>
to iterate over an image correctly.</p>
<p>First, we need an RGB565 image. The GIMP can export these quite easily - go to File -&gt; Export As or
press <kbd>Shift</kbd> + <kbd>Ctrl</kbd> + <kbd>E</kbd> and save as a file ending in <code>.bmp</code>. The BMP
export options dialog will now show up. Make sure you choose <code>Advanced Options</code> -&gt; <code>16 bits</code> -&gt;
<code>R5 G6 B5</code> option when exporting:</p>
<img src="/assets/images/rust-bmp-export.png" srcset="/assets/images/rust-bmp-export.png 2x" />
<p>Now we have a 16 bit BMP, it can be loaded into a Rust program using <code>include_bytes!()</code>, like this:</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">embedded_graphics<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">image<span class="z-punctuation z-accessor z-rust">::</span></span>ImageBmp<span class="z-punctuation z-terminator z-rust">;</span>
<span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">embedded_graphics<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">prelude<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-keyword z-operator z-arithmetic z-rust">*</span><span class="z-punctuation z-terminator z-rust">;</span>

<span class="z-storage z-type z-rust">let</span> im <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">ImageBmp<span class="z-punctuation z-accessor z-rust">::</span></span>new<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-support z-macro z-rust">include_bytes!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&quot;</span>./awesome-image.bmp<span class="z-punctuation z-definition z-string z-end z-rust">&quot;</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">unwrap</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></code></pre>
<p><code>im</code> can now be used to draw to a display compatible with Embedded Graphics with a simple
<code>disp.draw(im.into_iter())</code> command. There's a complete example
<a href="https://github.com/jamwaffles/ssd1331/blob/e55cc11c40fdaaa137b39c9853367864d767b856/examples/bmp.rs">here in the SSD1331 examples folder</a>
if you want to see a complete program.</p>
<p>Because Rust is awesome, it should be able to figure out whether you intended to use <code>PixelColourU8</code>
or <code>PixelColorU16</code> based on the type of pixel the display driver uses. 8BPP BMP images will be
converted to either type, and 16BPP BMP images will automatically convert two-byte words into a
<code>PixelColorU16</code> which should make more images compatible with more displays.</p>
<p>And that's it! BMP support is great for Embedded Graphics, as it's now far simpler to work with
images that are used in embedded projects. Hell, it's even just nice to get an image preview in the
file browser! More image formats will be added in the future, namely ones that support simple
compression like TGA <em>et al</em>, so stay tuned.</p>
</div>

  <footer role="contentinfo" class="footer">
  <a rel="me" href="https://mastodon.social/@jamwaffles">&nbsp;</a>

  <div class="inner">
    <div class="footer__bio">
      

      <div class="footer__bio__text">Personal blog of Rust developer and hobby CNC machinist James Waples. Living in Edinburgh, Scotland ðŸ´ó §ó ¢ó ³ó £ó ´ó ¿ â¤ï¸</div>
    </div>

    <div class="footer__links">
      <a href="https:&#x2F;&#x2F;wapl.es">James Waples&#x27; Internet Hole</a>

      <a
        href="/atom.xml"
        id="btn_feed"
        class="btn"
        title="Feed"
        target="_blank"
      >
        <span aria-hidden="true" data-icon=")"></span>
        <strong>RSS Feed</strong>
      </a>

      <span>Published with <a href="https://www.getzola.org">Zola</a></span>
    </div>
  </div>
</footer>

</article>


    

    <script
      data-goatcounter="https://jamwaffles.goatcounter.com/count"
      async
      src="//gc.zgo.at/count.js"
    ></script>
  </body>
</html>
