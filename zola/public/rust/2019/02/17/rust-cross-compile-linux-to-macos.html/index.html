<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />

  <link
    href="https://fonts.googleapis.com/css?family=Fira+Mono|Open+Sans|Oswald"
    rel="stylesheet"
  />
  <link rel="stylesheet" href="https://wapl.es/index.css" />

  <link rel="stylesheet" type="text/css" href="/syntax-theme-dark.css" media="(prefers-color-scheme: dark)" />
  <link rel="stylesheet" type="text/css" href="/syntax-theme-light.css" media="(prefers-color-scheme: light)" />
  
   
  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://wapl.es/atom.xml"> 
  <link rel="alternate" type="application/atom+xml" title="Atom" href="https://wapl.es/atom.xml"> 
  

  <title>Cross compiling Rust from Linux to macOS</title>
  <meta
    name="description"
    content="Personal blog of Rust developer and hobby CNC machinist James Waples. Living in Edinburgh, Scotland 🏴󠁧󠁢󠁳󠁣󠁴󠁿 ❤️"
  />

  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width initial-scale=1" />

  <link
    rel="apple-touch-icon"
    sizes="57x57"
    href="https://wapl.es/favicon/apple-icon-57x57.png"
  />
  <link
    rel="apple-touch-icon"
    sizes="60x60"
    href="https://wapl.es/favicon/apple-icon-60x60.png"
  />
  <link
    rel="apple-touch-icon"
    sizes="72x72"
    href="https://wapl.es/favicon/apple-icon-72x72.png"
  />
  <link
    rel="apple-touch-icon"
    sizes="76x76"
    href="https://wapl.es/favicon/apple-icon-76x76.png"
  />
  <link
    rel="apple-touch-icon"
    sizes="114x114"
    href="https://wapl.es/favicon/apple-icon-114x114.png"
  />
  <link
    rel="apple-touch-icon"
    sizes="120x120"
    href="https://wapl.es/favicon/apple-icon-120x120.png"
  />
  <link
    rel="apple-touch-icon"
    sizes="144x144"
    href="https://wapl.es/favicon/apple-icon-144x144.png"
  />
  <link
    rel="apple-touch-icon"
    sizes="152x152"
    href="https://wapl.es/favicon/apple-icon-152x152.png"
  />
  <link
    rel="apple-touch-icon"
    sizes="180x180"
    href="https://wapl.es/favicon/apple-icon-180x180.png"
  />
  <link
    rel="icon"
    type="image/png"
    sizes="192x192"
    href="https://wapl.es/favicon/android-icon-192x192.png"
  />
  <link
    rel="icon"
    type="image/png"
    sizes="32x32"
    href="https://wapl.es/favicon/favicon-32x32.png"
  />
  <link
    rel="icon"
    type="image/png"
    sizes="96x96"
    href="https://wapl.es/favicon/favicon-96x96.png"
  />
  <link
    rel="icon"
    type="image/png"
    sizes="16x16"
    href="https://wapl.es/favicon/favicon-16x16.png"
  />
  <meta name="msapplication-TileColor" content="#eeeeee" />
  <meta
    name="msapplication-TileImage"
    content="https://wapl.es/favicon/ms-icon-144x144.png"
  />
  <meta name="theme-color" content="#eeeeee" />

  <link
    rel="canonical"
    href="https:&#x2F;&#x2F;wapl.es&#x2F;rust&#x2F;2019&#x2F;02&#x2F;17&#x2F;rust-cross-compile-linux-to-macos.html&#x2F;"
  />
</head>


  <body class="">
    
<div class="post__header ">
  <header class="header" role="banner">
  <div class="wrap">
    <a class="site-title" href="https:&#x2F;&#x2F;wapl.es/">
      <h1 class="header__logo">
        <img
          src="https://wapl.es/images/logo-100-circle.png"
          alt="Hello it me, James. This is a picture of a banana trifle."
        />
        <span>James Waples&#x27; Internet Hole</span>
      </h1>
    </a>

    <aside class="header__links">
      <a href="/atom.xml" class="header__links__link">
        <span class="header__links__link__text">RSS</span>
        <svg alt="RSS" xmlns="http://www.w3.org/2000/svg" viewBox="0 -256 32 32">
          <path
            d="M8.7-228.4q0 1.9-1.2 3.1-1.3 1.3-3.1 1.3-1.9 0-3.1-1.3-1.3-1.2-1.3-3 0-1.9 1.3-3.2 1.2-1.2 3-1.2 1.9 0 3.2 1.2 1.2 1.3 1.2 3.1zm11.7 2.8q0 .7-.4 1.1-.4.5-1 .5h-3.2q-.5 0-1-.4-.3-.4-.4-1-.5-5.1-4.2-8.8-3.7-3.7-8.9-4.2-.6 0-1-.5-.3-.4-.3-1v-3q0-.7.5-1 .4-.5 1-.5 3.7.3 7 1.9 3.3 1.5 6 4 2.5 2.7 4 6 1.6 3.3 1.9 7zm11.6 0q0 .7-.4 1.1-.4.5-1 .5h-3.3q-.6 0-1-.4t-.5-1q-.2-4.9-2.3-9.3-2-4.3-5.2-7.6-3.3-3.2-7.7-5.2T1.4-250q-.6 0-1-.4t-.4-1v-3.2q0-.7.5-1 .4-.5 1-.5 6 .3 11.4 2.7 5.5 2.5 9.7 6.7 4.2 4.2 6.7 9.7 2.4 5.4 2.7 11.4z"
            fill="currentColor"
          />
        </svg>
      </a>

      <a href="https://github.com/sponsors/jamwaffles" target="_blank" class="header__links__link">
        <span class="header__links__link__text">Github Sponsors</span>
        <svg
          alt="Github Sponsors"
          xmlns="http://www.w3.org/2000/svg"
          width="43.438"
          height="42.366"
          viewBox="0 0 11.493 11.209"
        >
          <path
            d="M5.746 0A5.747 5.747 0 003.93 11.2c.287.052.392-.125.392-.278 0-.136-.005-.497-.008-.977-1.598.347-1.935-.77-1.935-.77-.262-.664-.639-.841-.639-.841-.521-.356.04-.35.04-.35.577.041.88.593.88.593.513.878 1.345.625 1.673.477.052-.37.2-.624.364-.768-1.276-.145-2.617-.638-2.617-2.84 0-.627.224-1.14.591-1.542-.059-.145-.256-.73.057-1.52 0 0 .482-.155 1.58.588.458-.127.95-.19 1.438-.193.489.002.98.066 1.44.193 1.096-.743 1.578-.589 1.578-.589.313.792.116 1.376.057 1.521.369.402.59.915.59 1.542 0 2.208-1.343 2.694-2.623 2.836.206.177.39.528.39 1.064 0 .768-.007 1.388-.007 1.576 0 .154.104.333.395.277A5.749 5.749 0 005.746 0"
            fill="currentColor"
            fill-rule="evenodd"
          />
        </svg>
      </a>

      <a href="https://liberapay.com/jamwaffles/" target="_blank" class="header__links__link">
        <span class="header__links__link__text">Liberapay</span>
        <svg alt="Liberapay" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 80 80">
          <path
            d="M80 72.4c0 4.2-3.4 7.7-7.7 7.7H7.8A7.7 7.7 0 010 72.4V7.8C0 3.6 3.5.1 7.8.1h64.5c4.3 0 7.8 3.5 7.8 7.7v64.6"
            fill="currentColor"
          />
          <g fill="#fff">
            <path
              d="M32.7 56.1a15 15 0 01-6.1-1 6.5 6.5 0 01-3.2-2.7 8 8 0 01-.9-4c0-1.5.2-3.1.6-4.8l7-29 8.4-1.2-7.6 31.3-.2 1.8c0 .6 0 1 .3 1.5.2.4.6.7 1 1 .6.2 1.3.4 2.3.5L32.7 56M63.1 38.1c0 2.7-.4 5.1-1.3 7.3a16.1 16.1 0 01-9.2 9.4 18.3 18.3 0 01-10.7 1l-2.4 9.9h-8.1l9-37.7a47.6 47.6 0 0111-1.7c2.1 0 3.9.3 5.3 1a9.8 9.8 0 015.8 6.2c.4 1.5.6 3 .6 4.6M43.4 49.3l2.3.2c1.4 0 2.7-.2 3.8-.8a8.5 8.5 0 003-2.2c.8-1 1.4-2 1.9-3.4.4-1.3.7-2.8.7-4.4 0-1.5-.4-2.8-1-4-.7-1-2-1.6-3.7-1.6-1.1 0-2.2.1-3.2.4l-3.8 15.8"
            />
          </g>
        </svg>
      </a>
    </aside>

    <hr />
  </div>
</header>

</div>


<article role="main" class="post ">
  <header>
    <a href="https:&#x2F;&#x2F;wapl.es" id="home_link">« Posts list</a>
    <div class="post__title">
      <h1>Cross compiling Rust from Linux to macOS</h1>

      <time datetime="2019-02-17"
        ><a href="https:&#x2F;&#x2F;wapl.es&#x2F;rust&#x2F;2019&#x2F;02&#x2F;17&#x2F;rust-cross-compile-linux-to-macos.html&#x2F;">February 17, 2019</a></time
      >
    </div>
  </header>

  <div class="post__text" id="js-post-content"><p>I've recently been working on a Rust project at <a href="https://repositive.io/">work</a> which requires
compiling for Linux (GNU), Linux (musl - for Alpine Linux) and macOS. I use Linux Mint nearly all
the time, so building for macOS targets has required asking very nicely to borrow a spare Macbook
Air. This is naturally a bit crap, so I set out to find a Linux-only solution to cross compile for
macOS using <a href="https://github.com/tpoechtrager/osxcross">osxcross</a>. A weekend of pain later, and I
have the following post. Hopefully it spares you a weekend of your own pain.</p>
<h2 id="environment">Environment</h2>
<p>This process should work in any modern-ish Debian-based environment. This is the setup I used:</p>
<ul>
<li>Linux Mint 19.1, Dell XPS1 15, Intel i9 x64</li>
<li>Rust 1.32.0 (with <a href="http://rustup.rs/">Rustup</a>)</li>
<li>Clang 6.0.0</li>
</ul>
<p>I've also tested this process in <a href="http://circleci.com/">CircleCI</a> and it seems to be working fine.</p>
<p>The only device I have to test on at time of writing is a Macbook Air with macOS Mojave on it. This
process <strong>should</strong> work for other macOS versions, but is untested.</p>
<h2 id="requirements">Requirements</h2>
<p>There are a few system dependencies required to work with osxcross. I don't think the version
requirements are too strict for the packages listed below. You may want to check the
<a href="https://github.com/tpoechtrager/osxcross#installation">osxcross requirements</a> as well if you're
having problems.</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> Install build dependencies</span><span class="z-comment z-line z-number-sign z-shell">
</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">apt</span></span><span class="z-meta z-function-call z-arguments z-shell"> install <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span>    clang <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span>    gcc <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span>    g++ <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span>    zlib1g-dev <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span>    libmpc-dev <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span>    libmpfr-dev <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span>    libgmp-dev</span>

<span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> Add macOS Rust target</span><span class="z-comment z-line z-number-sign z-shell">
</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">rustup</span></span><span class="z-meta z-function-call z-arguments z-shell"> target add x86_64-apple-darwin</span>
</span></code></pre>
<h2 id="building-osxcross">Building osxcross</h2>
<p>The following process is based on
<a href="https://www.reddit.com/r/rust/comments/6rxoty/tutorial_cross_compiling_from_linux_for_osx/">this tutorial on Reddit</a>
and some trial and error. I'm using the macOS 10.10 SDK as I had the least problems getting up and
running with it.</p>
<p>Add the following to a script called <code>osxcross_setup.sh</code> and make it executable.</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">git</span></span><span class="z-meta z-function-call z-arguments z-shell"> clone https://github.com/tpoechtrager/osxcross</span>
<span class="z-meta z-function-call z-shell"><span class="z-support z-function z-cd z-shell">cd</span></span><span class="z-meta z-function-call z-arguments z-shell"> osxcross</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">wget</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>nc</span> https://s3.dockerproject.org/darwin/v2/MacOSX10.10.sdk.tar.xz</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">mv</span></span><span class="z-meta z-function-call z-arguments z-shell"> MacOSX10.10.sdk.tar.xz tarballs/</span>
<span class="z-variable z-other z-readwrite z-assignment z-shell">UNATTENDED</span><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell">yes</span> <span class="z-variable z-other z-readwrite z-assignment z-shell">OSX_VERSION_MIN</span><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell">10.7</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">./build.sh</span></span>
</span></code></pre>
<p>Not a lot to it, thanks to the hard work put in by the osxcross developers. Running
<code>./osxcross_setup.sh</code> should create a folder named <code>osxcross</code> with everything you need in it to
cross compile to macOS with Clang. This doesn't modify <code>$PATH</code> or install any system files, so is
useful for CI as well.</p>
<p><em>Append <code>./build_gcc.sh</code> to <code>osxcross_setup.sh</code> if you want to use GCC to cross compile.</em></p>
<h2 id="configuring-cargo">Configuring Cargo</h2>
<p>Cargo needs to be told to use the correct linker for the <code>x86_64-apple-darwin</code> target, so add the
following to your project's <code>.cargo/config</code> file:</p>
<pre data-lang="toml" class="language-toml z-code"><code class="language-toml" data-lang="toml"><span class="z-source z-toml"><span class="z-punctuation z-definition z-table z-begin z-toml">[</span><span class="z-meta z-tag z-table z-toml"><span class="z-entity z-name z-table z-toml">target</span><span class="z-punctuation z-separator z-table z-toml">.</span><span class="z-entity z-name z-table z-toml">x86_64-apple-darwin</span></span><span class="z-punctuation z-definition z-table z-end z-toml">]</span>
<span class="z-meta z-tag z-key z-toml"><span class="z-entity z-name z-tag z-toml">linker</span></span> <span class="z-punctuation z-definition z-key-value z-toml">=</span> <span class="z-string z-quoted z-double z-basic z-toml"><span class="z-punctuation z-definition z-string z-begin z-toml">&quot;</span>x86_64-apple-darwin14-clang<span class="z-punctuation z-definition z-string z-end z-toml">&quot;</span></span>
<span class="z-meta z-tag z-key z-toml"><span class="z-entity z-name z-tag z-toml">ar</span></span> <span class="z-punctuation z-definition z-key-value z-toml">=</span> <span class="z-string z-quoted z-double z-basic z-toml"><span class="z-punctuation z-definition z-string z-begin z-toml">&quot;</span>x86_64-apple-darwin14-ar<span class="z-punctuation z-definition z-string z-end z-toml">&quot;</span></span>
</span></code></pre>
<p>If you've used a different macOS SDK version, you might need to replace <code>darwin14</code> with <code>darwin15</code>.
To check what binary to use, look in <code>osxcross/target/bin</code>.</p>
<h2 id="building-the-project">Building the project</h2>
<p>Because I chose not to install osxcross at the system level, the <code>$PATH</code> variable must be modified
for Cargo to pick up the linker binaries specified previously. The build command changes to:</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> Add --release to build in release mode</span><span class="z-comment z-line z-number-sign z-shell">
</span><span class="z-variable z-other z-readwrite z-assignment z-shell">PATH</span><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell"><span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span><span class="z-meta z-group z-expansion z-command z-parens z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-punctuation z-section z-parens z-begin z-shell">(</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">pwd</span></span><span class="z-punctuation z-section z-parens z-end z-shell">)</span></span>/osxcross/target/bin:<span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-other z-readwrite z-shell">PATH</span></span><span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span> <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">cargo</span></span><span class="z-meta z-function-call z-arguments z-shell"> build<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>target</span> x86_64-apple-darwin</span>
</span></code></pre>
<p>This adds <code>[pwd]/osxcross/target/bin</code> to <code>$PATH</code>, which means the linker binaries should get picked
up. The path must be absolute to work properly, hence <code>$(pwd)</code>.</p>
<p>Now you should have a binary in <code>target/x86_64-apple-darwin/[debug|release]</code> which works on macOS!</p>
<h2 id="building-sys-crates">Building <code>*-sys</code> crates</h2>
<p>You can stop here if none of your crates require any C bindings to function. Quite a few of them do,
so read on if you run into compilation or linking errors.</p>
<p>The project I'm cross compiling uses the <a href="https://crates.io/crates/git2">git2</a> crate which has
<a href="https://github.com/rust-lang/libz-sys/">libz-sys</a> in its dependency tree. Unfortunately this means
digging out a C compiler. The build uses the <em>host</em> system compiler by default, so the architectures
for the final binary (target arch) and these linked libraries (host arch) don't match up.</p>
<p>The solution to this is to set the <code>CC</code> and <code>CXX</code> environment variables in our build command:</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-variable z-other z-readwrite z-assignment z-shell">PATH</span><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell"><span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span><span class="z-meta z-group z-expansion z-command z-parens z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-punctuation z-section z-parens z-begin z-shell">(</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">pwd</span></span><span class="z-punctuation z-section z-parens z-end z-shell">)</span></span>/osxcross/target/bin:<span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-other z-readwrite z-shell">PATH</span></span><span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span> <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span><span class="z-variable z-other z-readwrite z-assignment z-shell">CC</span><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell">o64-clang</span> <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span><span class="z-variable z-other z-readwrite z-assignment z-shell">CXX</span><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell">o64-clang++</span> <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">cargo</span></span><span class="z-meta z-function-call z-arguments z-shell"> build<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>target</span> x86_64-apple-darwin</span>
</span></code></pre>
<p>This uses <code>o64-clang</code> and <code>o64-clang++</code> in <code>osxcross/target/bin</code>.</p>
<p>Now git2 compiles, but fails to link! This is due to the fact that libz-sys attempts to link to the
host system <code>zlib</code> library. Because I'm building on a Linux machine, this is a Linux-native library
which won't work on macOS.</p>
<p>Luckily, libz-sys supports building its own statically linked version of zlib. According to
<a href="https://github.com/rust-lang/libz-sys/blob/master/build.rs#L25">libz-sys' <code>build.rs</code></a>, if
<code>LIBZ_SYS_STATIC=1</code> is set in the environment a bundled version of zlib will be built. Because we
set <code>CC</code> and <code>CXX</code>, this statically linked code will be compiled for a macOS target. The full build
command ends up looking like this:</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-variable z-other z-readwrite z-assignment z-shell">PATH</span><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell"><span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span><span class="z-meta z-group z-expansion z-command z-parens z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-punctuation z-section z-parens z-begin z-shell">(</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">pwd</span></span><span class="z-punctuation z-section z-parens z-end z-shell">)</span></span>/osxcross/target/bin:<span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-other z-readwrite z-shell">PATH</span></span><span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span> <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span><span class="z-variable z-other z-readwrite z-assignment z-shell">CC</span><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell">o64-clang</span> <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span><span class="z-variable z-other z-readwrite z-assignment z-shell">CXX</span><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell">o64-clang++</span> <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span><span class="z-variable z-other z-readwrite z-assignment z-shell">LIBZ_SYS_STATIC</span><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell">1</span> <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">cargo</span></span><span class="z-meta z-function-call z-arguments z-shell"> build<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>target</span> x86_64-apple-darwin</span>
</span></code></pre>
<h2 id="ci">CI</h2>
<p>I got the above process working in CircleCI, but it should be pretty easy to get any Debian-based CI
service to work.</p>
<p>It should be possible to cache the <code>osxcross</code> folder so it doesn't have to be built for every job.
The cache should be invalidated when your build script(s) change. For example, I use the cache
checksum <code>project-v1-{{ &quot;{{&quot; }} checksum &quot;osxcross_setup.sh&quot; }}</code> to ensure the <code>osxcross</code> folder is
regenerated correctly.</p>
<h2 id="wrapping-up">Wrapping up</h2>
<p>The final build command is pretty long, so I'd suggest putting it in a script. In my case, I have a
build script containing the following snippet:</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> ... snip ...</span><span class="z-comment z-line z-number-sign z-shell">
</span>
<span class="z-variable z-other z-readwrite z-assignment z-shell">MACOS_TARGET</span><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell"><span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>x86_64-apple-darwin<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span>

<span class="z-meta z-function-call z-shell"><span class="z-support z-function z-echo z-shell">echo</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>Building target for platform <span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-punctuation z-section z-expansion z-parameter z-begin z-shell">{</span></span><span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-variable z-other z-readwrite z-shell">MACOS_TARGET</span></span><span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-section z-expansion z-parameter z-end z-shell">}</span></span><span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span>
<span class="z-meta z-function-call z-shell"><span class="z-support z-function z-echo z-shell">echo</span></span>

<span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> Add osxcross toolchain to path</span><span class="z-comment z-line z-number-sign z-shell">
</span><span class="z-meta z-function-call z-shell"><span class="z-storage z-modifier z-shell">export</span> <span class="z-variable z-other z-readwrite z-assignment z-shell">PATH</span><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell"><span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span><span class="z-meta z-group z-expansion z-command z-parens z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-punctuation z-section z-parens z-begin z-shell">(</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">pwd</span></span><span class="z-punctuation z-section z-parens z-end z-shell">)</span></span>/osxcross/target/bin:<span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-other z-readwrite z-shell">PATH</span></span><span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span></span>

<span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> Make libz-sys (git2-rs -&gt; libgit2-sys -&gt; libz-sys) build as a statically linked lib</span><span class="z-comment z-line z-number-sign z-shell">
</span><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> This prevents the host zlib from being linked</span><span class="z-comment z-line z-number-sign z-shell">
</span><span class="z-meta z-function-call z-shell"><span class="z-storage z-modifier z-shell">export</span> <span class="z-variable z-other z-readwrite z-assignment z-shell">LIBZ_SYS_STATIC</span><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell">1</span></span>

<span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> Use Clang for C/C++ builds</span><span class="z-comment z-line z-number-sign z-shell">
</span><span class="z-meta z-function-call z-shell"><span class="z-storage z-modifier z-shell">export</span> <span class="z-variable z-other z-readwrite z-assignment z-shell">CC</span><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell">o64-clang</span></span>
<span class="z-meta z-function-call z-shell"><span class="z-storage z-modifier z-shell">export</span> <span class="z-variable z-other z-readwrite z-assignment z-shell">CXX</span><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell">o64-clang++</span></span>

<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">cargo</span></span><span class="z-meta z-function-call z-arguments z-shell"> build<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>release</span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>target</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span><span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-punctuation z-section z-expansion z-parameter z-begin z-shell">{</span></span><span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-variable z-other z-readwrite z-shell">MACOS_TARGET</span></span><span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-section z-expansion z-parameter z-end z-shell">}</span></span><span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span>

<span class="z-meta z-function-call z-shell"><span class="z-support z-function z-echo z-shell">echo</span></span>
<span class="z-meta z-function-call z-shell"><span class="z-support z-function z-echo z-shell">echo</span></span><span class="z-meta z-function-call z-arguments z-shell"> Done</span>
</span></code></pre>
<p>Now you can just run <code>./osxcross_setup.sh</code> and <code>./build_macos.sh</code> in your CI.</p>
</div>

  <footer role="contentinfo" class="footer">
  <a rel="me" href="https://mastodon.social/@jamwaffles">&nbsp;</a>

  <div class="inner">
    <div class="footer__bio">
      

      <div class="footer__bio__text">Personal blog of Rust developer and hobby CNC machinist James Waples. Living in Edinburgh, Scotland 🏴󠁧󠁢󠁳󠁣󠁴󠁿 ❤️</div>
    </div>

    <div class="footer__links">
      <a href="https:&#x2F;&#x2F;wapl.es">James Waples&#x27; Internet Hole</a>

      <a
        href="/atom.xml"
        id="btn_feed"
        class="btn"
        title="Feed"
        target="_blank"
      >
        <span aria-hidden="true" data-icon=")"></span>
        <strong>RSS Feed</strong>
      </a>

      <span>Published with <a href="https://www.getzola.org">Zola</a></span>
    </div>
  </div>
</footer>

</article>


    

    <script
      data-goatcounter="https://jamwaffles.goatcounter.com/count"
      async
      src="//gc.zgo.at/count.js"
    ></script>
  </body>
</html>
