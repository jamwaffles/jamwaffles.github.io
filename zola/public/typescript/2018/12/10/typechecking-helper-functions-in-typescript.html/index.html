<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />

  <link
    href="https://fonts.googleapis.com/css?family=Fira+Mono|Open+Sans|Oswald"
    rel="stylesheet"
  />
  <link rel="stylesheet" href="https://wapl.es/index.css" />

  <link rel="stylesheet" type="text/css" href="/syntax-theme-dark.css" media="(prefers-color-scheme: dark)" />
  <link rel="stylesheet" type="text/css" href="/syntax-theme-light.css" media="(prefers-color-scheme: light)" />
  
   
  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://wapl.es/atom.xml"> 
  <link rel="alternate" type="application/atom+xml" title="Atom" href="https://wapl.es/atom.xml"> 
  

  <title>Typechecking builder functions in Typescript</title>
  <meta
    name="description"
    content="Personal blog of Rust developer and hobby CNC machinist James Waples. Living in Edinburgh, Scotland 🏴󠁧󠁢󠁳󠁣󠁴󠁿 ❤️"
  />

  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width initial-scale=1" />

  <link
    rel="apple-touch-icon"
    sizes="57x57"
    href="https://wapl.es/favicon/apple-icon-57x57.png"
  />
  <link
    rel="apple-touch-icon"
    sizes="60x60"
    href="https://wapl.es/favicon/apple-icon-60x60.png"
  />
  <link
    rel="apple-touch-icon"
    sizes="72x72"
    href="https://wapl.es/favicon/apple-icon-72x72.png"
  />
  <link
    rel="apple-touch-icon"
    sizes="76x76"
    href="https://wapl.es/favicon/apple-icon-76x76.png"
  />
  <link
    rel="apple-touch-icon"
    sizes="114x114"
    href="https://wapl.es/favicon/apple-icon-114x114.png"
  />
  <link
    rel="apple-touch-icon"
    sizes="120x120"
    href="https://wapl.es/favicon/apple-icon-120x120.png"
  />
  <link
    rel="apple-touch-icon"
    sizes="144x144"
    href="https://wapl.es/favicon/apple-icon-144x144.png"
  />
  <link
    rel="apple-touch-icon"
    sizes="152x152"
    href="https://wapl.es/favicon/apple-icon-152x152.png"
  />
  <link
    rel="apple-touch-icon"
    sizes="180x180"
    href="https://wapl.es/favicon/apple-icon-180x180.png"
  />
  <link
    rel="icon"
    type="image/png"
    sizes="192x192"
    href="https://wapl.es/favicon/android-icon-192x192.png"
  />
  <link
    rel="icon"
    type="image/png"
    sizes="32x32"
    href="https://wapl.es/favicon/favicon-32x32.png"
  />
  <link
    rel="icon"
    type="image/png"
    sizes="96x96"
    href="https://wapl.es/favicon/favicon-96x96.png"
  />
  <link
    rel="icon"
    type="image/png"
    sizes="16x16"
    href="https://wapl.es/favicon/favicon-16x16.png"
  />
  <meta name="msapplication-TileColor" content="#eeeeee" />
  <meta
    name="msapplication-TileImage"
    content="https://wapl.es/favicon/ms-icon-144x144.png"
  />
  <meta name="theme-color" content="#eeeeee" />

  <link
    rel="canonical"
    href="https:&#x2F;&#x2F;wapl.es&#x2F;typescript&#x2F;2018&#x2F;12&#x2F;10&#x2F;typechecking-helper-functions-in-typescript.html&#x2F;"
  />
</head>


  <body class="">
    
<div class="post__header ">
  <header class="header" role="banner">
  <div class="wrap">
    <a class="site-title" href="https:&#x2F;&#x2F;wapl.es/">
      <h1 class="header__logo">
        <img
          src="https://wapl.es/images/logo-100-circle.png"
          alt="Hello it me, James. This is a picture of a banana trifle."
        />
        <span>James Waples&#x27; Internet Hole</span>
      </h1>
    </a>

    <aside class="header__links">
      <a href="/atom.xml" class="header__links__link">
        <span class="header__links__link__text">RSS</span>
        <svg alt="RSS" xmlns="http://www.w3.org/2000/svg" viewBox="0 -256 32 32">
          <path
            d="M8.7-228.4q0 1.9-1.2 3.1-1.3 1.3-3.1 1.3-1.9 0-3.1-1.3-1.3-1.2-1.3-3 0-1.9 1.3-3.2 1.2-1.2 3-1.2 1.9 0 3.2 1.2 1.2 1.3 1.2 3.1zm11.7 2.8q0 .7-.4 1.1-.4.5-1 .5h-3.2q-.5 0-1-.4-.3-.4-.4-1-.5-5.1-4.2-8.8-3.7-3.7-8.9-4.2-.6 0-1-.5-.3-.4-.3-1v-3q0-.7.5-1 .4-.5 1-.5 3.7.3 7 1.9 3.3 1.5 6 4 2.5 2.7 4 6 1.6 3.3 1.9 7zm11.6 0q0 .7-.4 1.1-.4.5-1 .5h-3.3q-.6 0-1-.4t-.5-1q-.2-4.9-2.3-9.3-2-4.3-5.2-7.6-3.3-3.2-7.7-5.2T1.4-250q-.6 0-1-.4t-.4-1v-3.2q0-.7.5-1 .4-.5 1-.5 6 .3 11.4 2.7 5.5 2.5 9.7 6.7 4.2 4.2 6.7 9.7 2.4 5.4 2.7 11.4z"
            fill="currentColor"
          />
        </svg>
      </a>

      <a href="https://github.com/sponsors/jamwaffles" target="_blank" class="header__links__link">
        <span class="header__links__link__text">Github Sponsors</span>
        <svg
          alt="Github Sponsors"
          xmlns="http://www.w3.org/2000/svg"
          width="43.438"
          height="42.366"
          viewBox="0 0 11.493 11.209"
        >
          <path
            d="M5.746 0A5.747 5.747 0 003.93 11.2c.287.052.392-.125.392-.278 0-.136-.005-.497-.008-.977-1.598.347-1.935-.77-1.935-.77-.262-.664-.639-.841-.639-.841-.521-.356.04-.35.04-.35.577.041.88.593.88.593.513.878 1.345.625 1.673.477.052-.37.2-.624.364-.768-1.276-.145-2.617-.638-2.617-2.84 0-.627.224-1.14.591-1.542-.059-.145-.256-.73.057-1.52 0 0 .482-.155 1.58.588.458-.127.95-.19 1.438-.193.489.002.98.066 1.44.193 1.096-.743 1.578-.589 1.578-.589.313.792.116 1.376.057 1.521.369.402.59.915.59 1.542 0 2.208-1.343 2.694-2.623 2.836.206.177.39.528.39 1.064 0 .768-.007 1.388-.007 1.576 0 .154.104.333.395.277A5.749 5.749 0 005.746 0"
            fill="currentColor"
            fill-rule="evenodd"
          />
        </svg>
      </a>

      <a href="https://liberapay.com/jamwaffles/" target="_blank" class="header__links__link">
        <span class="header__links__link__text">Liberapay</span>
        <svg alt="Liberapay" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 80 80">
          <path
            d="M80 72.4c0 4.2-3.4 7.7-7.7 7.7H7.8A7.7 7.7 0 010 72.4V7.8C0 3.6 3.5.1 7.8.1h64.5c4.3 0 7.8 3.5 7.8 7.7v64.6"
            fill="currentColor"
          />
          <g fill="#fff">
            <path
              d="M32.7 56.1a15 15 0 01-6.1-1 6.5 6.5 0 01-3.2-2.7 8 8 0 01-.9-4c0-1.5.2-3.1.6-4.8l7-29 8.4-1.2-7.6 31.3-.2 1.8c0 .6 0 1 .3 1.5.2.4.6.7 1 1 .6.2 1.3.4 2.3.5L32.7 56M63.1 38.1c0 2.7-.4 5.1-1.3 7.3a16.1 16.1 0 01-9.2 9.4 18.3 18.3 0 01-10.7 1l-2.4 9.9h-8.1l9-37.7a47.6 47.6 0 0111-1.7c2.1 0 3.9.3 5.3 1a9.8 9.8 0 015.8 6.2c.4 1.5.6 3 .6 4.6M43.4 49.3l2.3.2c1.4 0 2.7-.2 3.8-.8a8.5 8.5 0 003-2.2c.8-1 1.4-2 1.9-3.4.4-1.3.7-2.8.7-4.4 0-1.5-.4-2.8-1-4-.7-1-2-1.6-3.7-1.6-1.1 0-2.2.1-3.2.4l-3.8 15.8"
            />
          </g>
        </svg>
      </a>
    </aside>

    <hr />
  </div>
</header>

</div>


<article role="main" class="post ">
  <header>
    <a href="https:&#x2F;&#x2F;wapl.es" id="home_link">« Posts list</a>
    <div class="post__title">
      <h1>Typechecking builder functions in Typescript</h1>

      <time datetime="2018-12-10"
        ><a href="https:&#x2F;&#x2F;wapl.es&#x2F;typescript&#x2F;2018&#x2F;12&#x2F;10&#x2F;typechecking-helper-functions-in-typescript.html&#x2F;">December 10, 2018</a></time
      >
    </div>
  </header>

  <div class="post__text" id="js-post-content"><p>I've been working on toasting a lot of our tech debt <a href="https://repositive.io">at Repositive</a>
recently. We use an event driven microservice architecture which has various benefits, but some
drawbacks concerning what data is sent where due in part to the liberal use of <code>any</code> in our
Typescript codebases. During my refactoring rampage, I encountered some places where event objects
were missing fields or otherwise weren't being generated properly. To this end, I set out to create
a type-checked solution to this problem.</p>
<h2 id="what-events-look-like-to-us">What events look like to us</h2>
<p>Firstly, an event as seen on a Repositive-branded wire looks like this (prettified):</p>
<pre data-lang="json" class="language-json z-code"><code class="language-json" data-lang="json"><span class="z-source z-json"><span class="z-meta z-mapping z-json"><span class="z-punctuation z-section z-mapping z-begin z-json">{</span>
  </span><span class="z-meta z-mapping z-key z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">&quot;</span>id<span class="z-punctuation z-definition z-string z-end z-json">&quot;</span></span></span><span class="z-meta z-mapping z-json"><span class="z-punctuation z-separator z-mapping z-key-value z-json">:</span> </span><span class="z-meta z-mapping z-value z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">&quot;</span>18efffd3-8b0d-48b4-bf3b-1e2d17a91822<span class="z-punctuation z-definition z-string z-end z-json">&quot;</span></span><span class="z-punctuation z-separator z-mapping z-pair z-json">,</span>
  </span><span class="z-meta z-mapping z-key z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">&quot;</span>data<span class="z-punctuation z-definition z-string z-end z-json">&quot;</span></span></span><span class="z-meta z-mapping z-value z-json"><span class="z-punctuation z-separator z-mapping z-key-value z-json">:</span> </span><span class="z-meta z-mapping z-value z-json"><span class="z-meta z-mapping z-json"><span class="z-punctuation z-section z-mapping z-begin z-json">{</span>
    </span><span class="z-meta z-mapping z-key z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">&quot;</span>type<span class="z-punctuation z-definition z-string z-end z-json">&quot;</span></span></span><span class="z-meta z-mapping z-json"><span class="z-punctuation z-separator z-mapping z-key-value z-json">:</span> </span><span class="z-meta z-mapping z-value z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">&quot;</span>some_namespace.SomeEventType<span class="z-punctuation z-definition z-string z-end z-json">&quot;</span></span><span class="z-punctuation z-separator z-mapping z-pair z-json">,</span>
    </span><span class="z-meta z-mapping z-key z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">&quot;</span>event_namespace<span class="z-punctuation z-definition z-string z-end z-json">&quot;</span></span></span><span class="z-meta z-mapping z-value z-json"><span class="z-punctuation z-separator z-mapping z-key-value z-json">:</span> </span><span class="z-meta z-mapping z-value z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">&quot;</span>some_namespace<span class="z-punctuation z-definition z-string z-end z-json">&quot;</span></span><span class="z-punctuation z-separator z-mapping z-pair z-json">,</span>
    </span><span class="z-meta z-mapping z-key z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">&quot;</span>event_type<span class="z-punctuation z-definition z-string z-end z-json">&quot;</span></span></span><span class="z-meta z-mapping z-value z-json"><span class="z-punctuation z-separator z-mapping z-key-value z-json">:</span> </span><span class="z-meta z-mapping z-value z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">&quot;</span>SomeEventType<span class="z-punctuation z-definition z-string z-end z-json">&quot;</span></span><span class="z-punctuation z-separator z-mapping z-pair z-json">,</span>
    </span><span class="z-meta z-mapping z-key z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">&quot;</span>some_field<span class="z-punctuation z-definition z-string z-end z-json">&quot;</span></span></span><span class="z-meta z-mapping z-value z-json"><span class="z-punctuation z-separator z-mapping z-key-value z-json">:</span> </span><span class="z-meta z-mapping z-value z-json"><span class="z-constant z-language z-json">true</span><span class="z-punctuation z-separator z-mapping z-pair z-json">,</span>
    </span><span class="z-meta z-mapping z-key z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">&quot;</span>some_other_field<span class="z-punctuation z-definition z-string z-end z-json">&quot;</span></span></span><span class="z-meta z-mapping z-value z-json"><span class="z-punctuation z-separator z-mapping z-key-value z-json">:</span> </span><span class="z-meta z-mapping z-value z-json"><span class="z-constant z-numeric z-integer z-decimal z-json">100</span>
  <span class="z-punctuation z-section z-mapping z-end z-json">}</span></span><span class="z-punctuation z-separator z-mapping z-pair z-json">,</span>
  </span><span class="z-meta z-mapping z-key z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">&quot;</span>context<span class="z-punctuation z-definition z-string z-end z-json">&quot;</span></span></span><span class="z-meta z-mapping z-value z-json"><span class="z-punctuation z-separator z-mapping z-key-value z-json">:</span> </span><span class="z-meta z-mapping z-value z-json"><span class="z-meta z-mapping z-json"><span class="z-punctuation z-section z-mapping z-begin z-json">{</span>
    </span><span class="z-meta z-mapping z-key z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">&quot;</span>time<span class="z-punctuation z-definition z-string z-end z-json">&quot;</span></span></span><span class="z-meta z-mapping z-json"><span class="z-punctuation z-separator z-mapping z-key-value z-json">:</span> </span><span class="z-meta z-mapping z-value z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">&quot;</span>2018-12-10T12:40:52Z<span class="z-punctuation z-definition z-string z-end z-json">&quot;</span></span>
  <span class="z-punctuation z-section z-mapping z-end z-json">}</span></span>
<span class="z-punctuation z-section z-mapping z-end z-json">}</span></span>
</span></code></pre>
<p>There's an ID field, a <code>data</code> payload and a <code>context</code> which holds (amongst other things IRL) and
event creation time.</p>
<p>Inside <code>data</code>, there are three fields common to <strong>all</strong> events which denote which type of event it
is:</p>
<ul>
<li><code>event_namespace</code> - the <em>namespace</em> (domain) from which this event was emitted (<code>accounts</code>,
<code>products</code>, etc).</li>
<li><code>event_type</code> - the <em>type</em> of this event, used to define what the payload should contain when
consuming the event.</li>
<li><code>type</code> - legacy field that contains both the above pieces of information.</li>
</ul>
<p>The rest of the fields inside <code>data</code> are freeform and can be anything, including nested objects, as
long as the object keys <code>type</code>, <code>event_type</code> and <code>event_namespace</code> are not used.</p>
<h2 id="typescript-implementation">Typescript implementation</h2>
<p>In Typescript, we define some types to use when handling events like the above. There's one that
holds the three common event type fields <code>EventData</code>:</p>
<pre data-lang="typescript" class="language-typescript z-code"><code class="language-typescript" data-lang="typescript"><span class="z-source z-ts"><span class="z-meta z-interface z-ts"><span class="z-storage z-type z-interface z-ts">interface</span> <span class="z-entity z-name z-type z-interface z-ts">EventData</span> <span class="z-punctuation z-definition z-block z-ts">{</span>
<span class="z-meta z-field z-declaration z-ts">  <span class="z-meta z-definition z-property z-ts"><span class="z-variable z-object z-property z-ts">type</span></span><span class="z-meta z-type z-annotation z-ts"><span class="z-keyword z-operator z-type z-annotation z-ts">:</span> <span class="z-support z-type z-primitive z-ts">string</span></span></span><span class="z-punctuation z-terminator z-statement z-ts">;</span>
<span class="z-meta z-field z-declaration z-ts">  <span class="z-meta z-definition z-property z-ts"><span class="z-variable z-object z-property z-ts">event_namespace</span></span><span class="z-meta z-type z-annotation z-ts"><span class="z-keyword z-operator z-type z-annotation z-ts">:</span> <span class="z-support z-type z-primitive z-ts">string</span></span></span><span class="z-punctuation z-terminator z-statement z-ts">;</span>
<span class="z-meta z-field z-declaration z-ts">  <span class="z-meta z-definition z-property z-ts"><span class="z-variable z-object z-property z-ts">event_type</span></span><span class="z-meta z-type z-annotation z-ts"><span class="z-keyword z-operator z-type z-annotation z-ts">:</span> <span class="z-support z-type z-primitive z-ts">string</span></span></span><span class="z-punctuation z-terminator z-statement z-ts">;</span>
<span class="z-punctuation z-definition z-block z-ts">}</span></span>
</span></code></pre>
<p>This forms the core of an event's payload. Next, there's a wrapping type called <code>Event</code> which is
what the complete event object should look like:</p>
<pre data-lang="typescript" class="language-typescript z-code"><code class="language-typescript" data-lang="typescript"><span class="z-source z-ts"><span class="z-meta z-interface z-ts"><span class="z-storage z-type z-interface z-ts">interface</span> <span class="z-entity z-name z-type z-interface z-ts">Event</span><span class="z-meta z-type z-parameters z-ts"><span class="z-punctuation z-definition z-typeparameters z-begin z-ts">&lt;</span><span class="z-entity z-name z-type z-ts">D</span> <span class="z-storage z-modifier z-ts">extends</span> <span class="z-entity z-name z-type z-ts">EventData</span><span class="z-punctuation z-definition z-typeparameters z-end z-ts">&gt;</span></span> <span class="z-punctuation z-definition z-block z-ts">{</span>
<span class="z-meta z-field z-declaration z-ts">  <span class="z-meta z-definition z-property z-ts"><span class="z-variable z-object z-property z-ts">id</span></span><span class="z-meta z-type z-annotation z-ts"><span class="z-keyword z-operator z-type z-annotation z-ts">:</span> <span class="z-support z-type z-primitive z-ts">string</span></span></span><span class="z-punctuation z-terminator z-statement z-ts">;</span>
<span class="z-meta z-field z-declaration z-ts">  <span class="z-meta z-definition z-property z-ts"><span class="z-variable z-object z-property z-ts">data</span></span><span class="z-meta z-type z-annotation z-ts"><span class="z-keyword z-operator z-type z-annotation z-ts">:</span> <span class="z-entity z-name z-type z-ts">D</span></span></span><span class="z-punctuation z-terminator z-statement z-ts">;</span>
<span class="z-meta z-field z-declaration z-ts">  <span class="z-meta z-definition z-property z-ts"><span class="z-variable z-object z-property z-ts">context</span></span><span class="z-meta z-type z-annotation z-ts"><span class="z-keyword z-operator z-type z-annotation z-ts">:</span> <span class="z-meta z-object z-type z-ts"><span class="z-punctuation z-definition z-block z-ts">{</span><span class="z-meta z-field z-declaration z-ts"> <span class="z-meta z-definition z-property z-ts"><span class="z-variable z-object z-property z-ts">time</span></span><span class="z-meta z-type z-annotation z-ts"><span class="z-keyword z-operator z-type z-annotation z-ts">:</span> <span class="z-support z-type z-primitive z-ts">string</span> </span></span><span class="z-punctuation z-definition z-block z-ts">}</span></span></span></span><span class="z-punctuation z-terminator z-statement z-ts">;</span>
<span class="z-punctuation z-definition z-block z-ts">}</span></span>
</span></code></pre>
<p>And finally let's define the event given in the JSON example above:</p>
<pre data-lang="typescript" class="language-typescript z-code"><code class="language-typescript" data-lang="typescript"><span class="z-source z-ts"><span class="z-meta z-interface z-ts"><span class="z-storage z-type z-interface z-ts">interface</span> <span class="z-entity z-name z-type z-interface z-ts">BlogEvent</span> <span class="z-storage z-modifier z-ts">extends</span> <span class="z-entity z-other z-inherited-class z-ts">EventData</span> <span class="z-punctuation z-definition z-block z-ts">{</span>
<span class="z-meta z-field z-declaration z-ts">  <span class="z-meta z-definition z-property z-ts"><span class="z-variable z-object z-property z-ts">some_field</span></span><span class="z-meta z-type z-annotation z-ts"><span class="z-keyword z-operator z-type z-annotation z-ts">:</span> <span class="z-support z-type z-primitive z-ts">boolean</span></span></span><span class="z-punctuation z-terminator z-statement z-ts">;</span>
<span class="z-meta z-field z-declaration z-ts">  <span class="z-meta z-definition z-property z-ts"><span class="z-variable z-object z-property z-ts">some_other_field</span></span><span class="z-meta z-type z-annotation z-ts"><span class="z-keyword z-operator z-type z-annotation z-ts">:</span> <span class="z-support z-type z-primitive z-ts">number</span></span></span><span class="z-punctuation z-terminator z-statement z-ts">;</span>
<span class="z-punctuation z-definition z-block z-ts">}</span></span>
</span></code></pre>
<p>Note that I'm using <code>string</code> a lot here. You should probably create type aliases like
<code>type Uuid = string;</code>. It might not aid with format checking, but it will at least make clear to
other programmers what the intent of that field is.</p>
<p>A better idea might be to use <a href="https://www.npmjs.com/package/io-ts">io-ts</a> which would let you do
awesome things like validate your payloads at runtime using the type system!</p>
<p>Anyway, now that those types are defined, events can be created that match the correct type
signature:</p>
<pre data-lang="typescript" class="language-typescript z-code"><code class="language-typescript" data-lang="typescript"><span class="z-source z-ts"><span class="z-meta z-import z-ts"><span class="z-keyword z-control z-import z-ts">import</span> <span class="z-meta z-block z-ts"><span class="z-punctuation z-definition z-block z-ts">{</span> <span class="z-variable z-other z-readwrite z-alias z-ts">v4</span> <span class="z-punctuation z-definition z-block z-ts">}</span></span> <span class="z-keyword z-control z-from z-ts">from</span> <span class="z-string z-quoted z-double z-ts"><span class="z-punctuation z-definition z-string z-begin z-ts">&quot;</span>uuid<span class="z-punctuation z-definition z-string z-end z-ts">&quot;</span></span></span><span class="z-punctuation z-terminator z-statement z-ts">;</span>

<span class="z-meta z-var z-expr z-ts"><span class="z-storage z-type z-ts">const</span> <span class="z-meta z-var-single-variable z-expr z-ts"><span class="z-meta z-definition z-variable z-ts"><span class="z-variable z-other z-constant z-ts">emit_this</span></span><span class="z-meta z-type z-annotation z-ts"><span class="z-keyword z-operator z-type z-annotation z-ts">:</span> <span class="z-entity z-name z-type z-ts">Event</span><span class="z-meta z-type z-parameters z-ts"><span class="z-punctuation z-definition z-typeparameters z-begin z-ts">&lt;</span></span><span class="z-meta z-type z-parameters z-ts"><span class="z-entity z-name z-type z-ts">BlogEvent</span></span><span class="z-meta z-type z-parameters z-ts"><span class="z-punctuation z-definition z-typeparameters z-end z-ts">&gt;</span></span> </span></span><span class="z-keyword z-operator z-assignment z-ts">=</span> <span class="z-meta z-objectliteral z-ts"><span class="z-punctuation z-definition z-block z-ts">{</span>
  <span class="z-meta z-object z-member z-ts"><span class="z-meta z-object-literal z-key z-ts">id</span></span><span class="z-meta z-object z-member z-ts"><span class="z-meta z-object-literal z-key z-ts"><span class="z-punctuation z-separator z-key-value z-ts">:</span></span> <span class="z-meta z-function-call z-ts"><span class="z-entity z-name z-function z-ts">v4</span></span><span class="z-meta z-brace z-round z-ts">(</span><span class="z-meta z-brace z-round z-ts">)</span></span><span class="z-punctuation z-separator z-comma z-ts">,</span>
  <span class="z-meta z-object z-member z-ts"><span class="z-meta z-object-literal z-key z-ts">data</span></span><span class="z-meta z-object z-member z-ts"><span class="z-meta z-object-literal z-key z-ts"><span class="z-punctuation z-separator z-key-value z-ts">:</span></span> <span class="z-meta z-objectliteral z-ts"><span class="z-punctuation z-definition z-block z-ts">{</span>
    <span class="z-meta z-object z-member z-ts"><span class="z-meta z-object-literal z-key z-ts">type</span></span><span class="z-meta z-object z-member z-ts"><span class="z-meta z-object-literal z-key z-ts"><span class="z-punctuation z-separator z-key-value z-ts">:</span></span> <span class="z-string z-quoted z-double z-ts"><span class="z-punctuation z-definition z-string z-begin z-ts">&quot;</span>some_namespace.SomeEventType<span class="z-punctuation z-definition z-string z-end z-ts">&quot;</span></span></span><span class="z-punctuation z-separator z-comma z-ts">,</span>
    <span class="z-meta z-object z-member z-ts"><span class="z-meta z-object-literal z-key z-ts">event_namespace</span></span><span class="z-meta z-object z-member z-ts"><span class="z-meta z-object-literal z-key z-ts"><span class="z-punctuation z-separator z-key-value z-ts">:</span></span> <span class="z-string z-quoted z-double z-ts"><span class="z-punctuation z-definition z-string z-begin z-ts">&quot;</span>some_namespace<span class="z-punctuation z-definition z-string z-end z-ts">&quot;</span></span></span><span class="z-punctuation z-separator z-comma z-ts">,</span>
    <span class="z-meta z-object z-member z-ts"><span class="z-meta z-object-literal z-key z-ts">event_type</span></span><span class="z-meta z-object z-member z-ts"><span class="z-meta z-object-literal z-key z-ts"><span class="z-punctuation z-separator z-key-value z-ts">:</span></span> <span class="z-string z-quoted z-double z-ts"><span class="z-punctuation z-definition z-string z-begin z-ts">&quot;</span>SomeEventType<span class="z-punctuation z-definition z-string z-end z-ts">&quot;</span></span></span><span class="z-punctuation z-separator z-comma z-ts">,</span>
    <span class="z-meta z-object z-member z-ts"><span class="z-meta z-object-literal z-key z-ts">some_field</span></span><span class="z-meta z-object z-member z-ts"><span class="z-meta z-object-literal z-key z-ts"><span class="z-punctuation z-separator z-key-value z-ts">:</span></span> <span class="z-constant z-language z-boolean z-true z-ts">true</span></span><span class="z-punctuation z-separator z-comma z-ts">,</span>
    <span class="z-meta z-object z-member z-ts"><span class="z-meta z-object-literal z-key z-ts">some_other_field</span></span><span class="z-meta z-object z-member z-ts"><span class="z-meta z-object-literal z-key z-ts"><span class="z-punctuation z-separator z-key-value z-ts">:</span></span> <span class="z-constant z-numeric z-decimal z-ts">100</span></span><span class="z-punctuation z-separator z-comma z-ts">,</span>
  <span class="z-punctuation z-definition z-block z-ts">}</span></span></span><span class="z-punctuation z-separator z-comma z-ts">,</span>
  <span class="z-meta z-object z-member z-ts"><span class="z-meta z-object-literal z-key z-ts">context</span></span><span class="z-meta z-object z-member z-ts"><span class="z-meta z-object-literal z-key z-ts"><span class="z-punctuation z-separator z-key-value z-ts">:</span></span> <span class="z-meta z-objectliteral z-ts"><span class="z-punctuation z-definition z-block z-ts">{</span>
    <span class="z-meta z-object z-member z-ts"><span class="z-meta z-object-literal z-key z-ts">time</span></span><span class="z-meta z-object z-member z-ts"><span class="z-meta z-object-literal z-key z-ts"><span class="z-punctuation z-separator z-key-value z-ts">:</span></span> <span class="z-new z-expr z-ts"><span class="z-keyword z-operator z-new z-ts">new</span> <span class="z-entity z-name z-type z-ts">Date</span><span class="z-meta z-brace z-round z-ts">(</span><span class="z-meta z-brace z-round z-ts">)</span></span><span class="z-meta z-function-call z-ts"><span class="z-punctuation z-accessor z-ts">.</span><span class="z-entity z-name z-function z-ts">toISOString</span></span><span class="z-meta z-brace z-round z-ts">(</span><span class="z-meta z-brace z-round z-ts">)</span></span><span class="z-punctuation z-separator z-comma z-ts">,</span>
  <span class="z-punctuation z-definition z-block z-ts">}</span></span></span><span class="z-punctuation z-separator z-comma z-ts">,</span>
<span class="z-punctuation z-definition z-block z-ts">}</span></span></span><span class="z-punctuation z-terminator z-statement z-ts">;</span>
</span></code></pre>
<p>This isn't too bad. Fields in <code>data</code> can't be missed and, critically, the event metadata (<code>type</code>,
<code>event_namespace</code> and <code>event_type</code>) fields can't be typoed! Thanks Typescript!</p>
<h2 id="first-attempt-lazy-is-dangerous">First attempt: lazy is dangerous</h2>
<p>The above is alright I guess. At least the final event object is checked at compile time before
serializing and sending/storing it. The problem is it's pretty verbose. Wouldn't it be nicer to have
a function that, given a <code>data</code> payload <em>just makes us an event</em>? This is what I came up with to
solve this problem the first time:</p>
<pre data-lang="typescript" class="language-typescript z-code"><code class="language-typescript" data-lang="typescript"><span class="z-source z-ts"><span class="z-meta z-import z-ts"><span class="z-keyword z-control z-import z-ts">import</span> <span class="z-meta z-block z-ts"><span class="z-punctuation z-definition z-block z-ts">{</span> <span class="z-variable z-other z-readwrite z-alias z-ts">v4</span> <span class="z-punctuation z-definition z-block z-ts">}</span></span> <span class="z-keyword z-control z-from z-ts">from</span> <span class="z-string z-quoted z-single z-ts"><span class="z-punctuation z-definition z-string z-begin z-ts">&#39;</span>uuid<span class="z-punctuation z-definition z-string z-end z-ts">&#39;</span></span></span><span class="z-punctuation z-terminator z-statement z-ts">;</span>

<span class="z-meta z-function z-ts"><span class="z-keyword z-control z-export z-ts">export</span> <span class="z-storage z-type z-function z-ts">function</span> <span class="z-meta z-definition z-function z-ts"><span class="z-entity z-name z-function z-ts">createEvent</span></span><span class="z-meta z-parameters z-ts"><span class="z-punctuation z-definition z-parameters z-begin z-ts">(</span>
  <span class="z-variable z-parameter z-ts">event_namespace</span><span class="z-meta z-type z-annotation z-ts"><span class="z-keyword z-operator z-type z-annotation z-ts">:</span> <span class="z-support z-type z-primitive z-ts">string</span></span><span class="z-punctuation z-separator z-parameter z-ts">,</span>
  <span class="z-variable z-parameter z-ts">event_type</span><span class="z-meta z-type z-annotation z-ts"><span class="z-keyword z-operator z-type z-annotation z-ts">:</span> <span class="z-support z-type z-primitive z-ts">string</span></span><span class="z-punctuation z-separator z-parameter z-ts">,</span>
  <span class="z-variable z-parameter z-ts">data</span><span class="z-meta z-type z-annotation z-ts"><span class="z-keyword z-operator z-type z-annotation z-ts">:</span> <span class="z-support z-type z-builtin z-ts">object</span>
</span><span class="z-punctuation z-definition z-parameters z-end z-ts">)</span></span><span class="z-meta z-return z-type z-ts"><span class="z-keyword z-operator z-type z-annotation z-ts">:</span> <span class="z-entity z-name z-type z-ts">Event</span><span class="z-meta z-type z-parameters z-ts"><span class="z-punctuation z-definition z-typeparameters z-begin z-ts">&lt;</span></span><span class="z-meta z-type z-parameters z-ts"><span class="z-entity z-name z-type z-ts">EventData</span></span><span class="z-meta z-type z-parameters z-ts"><span class="z-punctuation z-definition z-typeparameters z-end z-ts">&gt;</span></span> </span><span class="z-meta z-block z-ts"><span class="z-punctuation z-definition z-block z-ts">{</span>
  <span class="z-keyword z-control z-flow z-ts">return</span><span class="z-meta z-objectliteral z-ts"> <span class="z-punctuation z-definition z-block z-ts">{</span>
    <span class="z-meta z-object z-member z-ts"><span class="z-meta z-object-literal z-key z-ts">id</span></span><span class="z-meta z-object z-member z-ts"><span class="z-meta z-object-literal z-key z-ts"><span class="z-punctuation z-separator z-key-value z-ts">:</span></span> <span class="z-meta z-function-call z-ts"><span class="z-entity z-name z-function z-ts">v4</span></span><span class="z-meta z-brace z-round z-ts">(</span><span class="z-meta z-brace z-round z-ts">)</span></span><span class="z-punctuation z-separator z-comma z-ts">,</span>
    <span class="z-meta z-object z-member z-ts"><span class="z-meta z-object-literal z-key z-ts">data</span></span><span class="z-meta z-object z-member z-ts"><span class="z-meta z-object-literal z-key z-ts"><span class="z-punctuation z-separator z-key-value z-ts">:</span></span> <span class="z-meta z-objectliteral z-ts"><span class="z-punctuation z-definition z-block z-ts">{</span>
      <span class="z-meta z-object z-member z-ts"><span class="z-keyword z-operator z-spread z-ts">...</span><span class="z-variable z-other z-readwrite z-ts">data</span></span><span class="z-punctuation z-separator z-comma z-ts">,</span>
      <span class="z-meta z-object z-member z-ts"><span class="z-meta z-object-literal z-key z-ts">type</span></span><span class="z-meta z-object z-member z-ts"><span class="z-meta z-object-literal z-key z-ts"><span class="z-punctuation z-separator z-key-value z-ts">:</span></span> <span class="z-string z-template z-ts"><span class="z-punctuation z-definition z-string z-template z-begin z-ts">`</span><span class="z-meta z-template z-expression z-ts"><span class="z-punctuation z-definition z-template-expression z-begin z-ts">${</span></span><span class="z-meta z-template z-expression z-ts"><span class="z-meta z-embedded z-line z-ts"><span class="z-variable z-other z-readwrite z-ts">event_namespace</span></span><span class="z-punctuation z-definition z-template-expression z-end z-ts">}</span></span>.<span class="z-meta z-template z-expression z-ts"><span class="z-punctuation z-definition z-template-expression z-begin z-ts">${</span></span><span class="z-meta z-template z-expression z-ts"><span class="z-meta z-embedded z-line z-ts"><span class="z-variable z-other z-readwrite z-ts">event_type</span></span><span class="z-punctuation z-definition z-template-expression z-end z-ts">}</span></span><span class="z-punctuation z-definition z-string z-template z-end z-ts">`</span></span></span><span class="z-punctuation z-separator z-comma z-ts">,</span>
      <span class="z-meta z-object z-member z-ts"><span class="z-variable z-other z-readwrite z-ts">event_type</span></span><span class="z-punctuation z-separator z-comma z-ts">,</span>
      <span class="z-meta z-object z-member z-ts"><span class="z-variable z-other z-readwrite z-ts">event_namespace</span></span><span class="z-punctuation z-separator z-comma z-ts">,</span>
    <span class="z-punctuation z-definition z-block z-ts">}</span></span></span><span class="z-punctuation z-separator z-comma z-ts">,</span>
    <span class="z-meta z-object z-member z-ts"><span class="z-meta z-object-literal z-key z-ts">context</span></span><span class="z-meta z-object z-member z-ts"><span class="z-meta z-object-literal z-key z-ts"><span class="z-punctuation z-separator z-key-value z-ts">:</span></span> <span class="z-meta z-objectliteral z-ts"><span class="z-punctuation z-definition z-block z-ts">{</span> <span class="z-meta z-object z-member z-ts"><span class="z-meta z-object-literal z-key z-ts">time</span></span><span class="z-meta z-object z-member z-ts"><span class="z-meta z-object-literal z-key z-ts"><span class="z-punctuation z-separator z-key-value z-ts">:</span></span> <span class="z-meta z-brace z-round z-ts">(</span><span class="z-new z-expr z-ts"><span class="z-keyword z-operator z-new z-ts">new</span> <span class="z-entity z-name z-type z-ts">Date</span><span class="z-meta z-brace z-round z-ts">(</span><span class="z-meta z-brace z-round z-ts">)</span></span><span class="z-meta z-brace z-round z-ts">)</span><span class="z-meta z-function-call z-ts"><span class="z-punctuation z-accessor z-ts">.</span><span class="z-entity z-name z-function z-ts">toISOString</span></span><span class="z-meta z-brace z-round z-ts">(</span><span class="z-meta z-brace z-round z-ts">)</span></span><span class="z-punctuation z-separator z-comma z-ts">,</span>
  <span class="z-punctuation z-definition z-block z-ts">}</span></span>;
</span><span class="z-punctuation z-definition z-block z-ts">}</span></span>

</span></span></span></code></pre>
<p>Neat. Now the programmer doesn't have to care about the particular shape of the object, just some
specific fields. Usage looks like this:</p>
<pre data-lang="typescript" class="language-typescript z-code"><code class="language-typescript" data-lang="typescript"><span class="z-source z-ts"><span class="z-meta z-var z-expr z-ts"><span class="z-storage z-type z-ts">const</span> <span class="z-meta z-var-single-variable z-expr z-ts"><span class="z-meta z-definition z-variable z-ts"><span class="z-variable z-other z-constant z-ts">emit_this</span></span> </span><span class="z-keyword z-operator z-assignment z-ts">=</span> <span class="z-meta z-function-call z-ts"><span class="z-entity z-name z-function z-ts">createEvent</span></span><span class="z-meta z-brace z-round z-ts">(</span><span class="z-string z-quoted z-double z-ts"><span class="z-punctuation z-definition z-string z-begin z-ts">&quot;</span>some_namespace<span class="z-punctuation z-definition z-string z-end z-ts">&quot;</span></span><span class="z-punctuation z-separator z-comma z-ts">,</span> <span class="z-string z-quoted z-double z-ts"><span class="z-punctuation z-definition z-string z-begin z-ts">&quot;</span>SomeEventType<span class="z-punctuation z-definition z-string z-end z-ts">&quot;</span></span><span class="z-punctuation z-separator z-comma z-ts">,</span> <span class="z-meta z-objectliteral z-ts"><span class="z-punctuation z-definition z-block z-ts">{</span>
  <span class="z-meta z-object z-member z-ts"><span class="z-meta z-object-literal z-key z-ts">some_field</span></span><span class="z-meta z-object z-member z-ts"><span class="z-meta z-object-literal z-key z-ts"><span class="z-punctuation z-separator z-key-value z-ts">:</span></span> <span class="z-constant z-language z-boolean z-true z-ts">true</span></span><span class="z-punctuation z-separator z-comma z-ts">,</span>
  <span class="z-meta z-object z-member z-ts"><span class="z-meta z-object-literal z-key z-ts">some_other_field</span></span><span class="z-meta z-object z-member z-ts"><span class="z-meta z-object-literal z-key z-ts"><span class="z-punctuation z-separator z-key-value z-ts">:</span></span> <span class="z-constant z-numeric z-decimal z-ts">100</span></span><span class="z-punctuation z-separator z-comma z-ts">,</span>
<span class="z-punctuation z-definition z-block z-ts">}</span></span><span class="z-meta z-brace z-round z-ts">)</span></span><span class="z-punctuation z-terminator z-statement z-ts">;</span>
</span></code></pre>
<p>This is obviously a lot cleaner. The programmer doesn't have to worry about the joined <code>type</code> field
matching <code>event_namespace</code> and <code>event_type</code> anymore, and the UUID and timestamp are automatically
inserted in the right places. The event's shape will also always be correct. But there's a
problem...</p>
<p>Typescript doesn't type check this properly! At least it didn't at the time of writing. For example,
adding an explicit type still doesn't catch the incorrect spelling of <code>some_namespace</code> in the
example below:</p>
<pre data-lang="typescript" class="language-typescript z-code"><code class="language-typescript" data-lang="typescript"><span class="z-source z-ts"><span class="z-meta z-var z-expr z-ts"><span class="z-storage z-type z-ts">const</span> <span class="z-meta z-var-single-variable z-expr z-ts"><span class="z-meta z-definition z-variable z-ts"><span class="z-variable z-other z-constant z-ts">emit_this</span></span><span class="z-meta z-type z-annotation z-ts"><span class="z-keyword z-operator z-type z-annotation z-ts">:</span> <span class="z-entity z-name z-type z-ts">Event</span><span class="z-meta z-type z-parameters z-ts"><span class="z-punctuation z-definition z-typeparameters z-begin z-ts">&lt;</span></span><span class="z-meta z-type z-parameters z-ts"><span class="z-entity z-name z-type z-ts">BlogEvent</span></span><span class="z-meta z-type z-parameters z-ts"><span class="z-punctuation z-definition z-typeparameters z-end z-ts">&gt;</span></span> </span></span><span class="z-keyword z-operator z-assignment z-ts">=</span> <span class="z-meta z-function-call z-ts"><span class="z-entity z-name z-function z-ts">createEvent</span></span><span class="z-meta z-brace z-round z-ts">(</span><span class="z-string z-quoted z-double z-ts"><span class="z-punctuation z-definition z-string z-begin z-ts">&quot;</span>potato<span class="z-punctuation z-definition z-string z-end z-ts">&quot;</span></span><span class="z-punctuation z-separator z-comma z-ts">,</span> <span class="z-string z-quoted z-double z-ts"><span class="z-punctuation z-definition z-string z-begin z-ts">&quot;</span>SomeEventType<span class="z-punctuation z-definition z-string z-end z-ts">&quot;</span></span><span class="z-punctuation z-separator z-comma z-ts">,</span> <span class="z-meta z-objectliteral z-ts"><span class="z-punctuation z-definition z-block z-ts">{</span>
  <span class="z-meta z-object z-member z-ts"><span class="z-meta z-object-literal z-key z-ts">some_field</span></span><span class="z-meta z-object z-member z-ts"><span class="z-meta z-object-literal z-key z-ts"><span class="z-punctuation z-separator z-key-value z-ts">:</span></span> <span class="z-constant z-language z-boolean z-true z-ts">true</span></span><span class="z-punctuation z-separator z-comma z-ts">,</span>
  <span class="z-meta z-object z-member z-ts"><span class="z-meta z-object-literal z-key z-ts">some_other_field</span></span><span class="z-meta z-object z-member z-ts"><span class="z-meta z-object-literal z-key z-ts"><span class="z-punctuation z-separator z-key-value z-ts">:</span></span> <span class="z-constant z-numeric z-decimal z-ts">100</span></span><span class="z-punctuation z-separator z-comma z-ts">,</span>
<span class="z-punctuation z-definition z-block z-ts">}</span></span><span class="z-meta z-brace z-round z-ts">)</span></span><span class="z-punctuation z-terminator z-statement z-ts">;</span>
</span></code></pre>
<p>This is more ergonomic, <strong>but is a step backward in the reliability of the system</strong>. Mistyped fields
and events with missing keys were encountered <em>in production</em> when using the <code>createEvent</code> defined
above. This is pretty terrible. We should be pushing the programmer into the
<a href="https://blog.codinghorror.com/falling-into-the-pit-of-success/">pit of success</a>!</p>
<h2 id="into-the-pit-safely">Into the pit - safely</h2>
<p>What <code>createEvent</code> needs is some actual, smart type checking. Issues arose when we decided to make
<code>createEvent</code> construct the returned object from a few different fields in its arguments.
Typechecking multiple arguments that get munged into a single object is pretty difficult (at least
in Typescript) but can be done as you'll see next:</p>
<pre data-lang="typescript" class="language-typescript z-code"><code class="language-typescript" data-lang="typescript"><span class="z-source z-ts"><span class="z-meta z-import z-ts"><span class="z-keyword z-control z-import z-ts">import</span> <span class="z-meta z-block z-ts"><span class="z-punctuation z-definition z-block z-ts">{</span> <span class="z-variable z-other z-readwrite z-alias z-ts">v4</span> <span class="z-punctuation z-definition z-block z-ts">}</span></span> <span class="z-keyword z-control z-from z-ts">from</span> <span class="z-string z-quoted z-double z-ts"><span class="z-punctuation z-definition z-string z-begin z-ts">&quot;</span>uuid<span class="z-punctuation z-definition z-string z-end z-ts">&quot;</span></span></span><span class="z-punctuation z-terminator z-statement z-ts">;</span>

<span class="z-meta z-type z-declaration z-ts"><span class="z-storage z-type z-type z-ts">type</span> <span class="z-entity z-name z-type z-alias z-ts">Omit</span><span class="z-meta z-type z-parameters z-ts"><span class="z-punctuation z-definition z-typeparameters z-begin z-ts">&lt;</span><span class="z-entity z-name z-type z-ts">T</span><span class="z-punctuation z-separator z-comma z-ts">,</span> <span class="z-entity z-name z-type z-ts">K</span> <span class="z-storage z-modifier z-ts">extends</span> <span class="z-keyword z-operator z-expression z-keyof z-ts">keyof</span> <span class="z-entity z-name z-type z-ts">T</span><span class="z-punctuation z-definition z-typeparameters z-end z-ts">&gt;</span></span> <span class="z-keyword z-operator z-assignment z-ts">=</span> <span class="z-entity z-name z-type z-ts">Pick</span><span class="z-meta z-type z-parameters z-ts"><span class="z-punctuation z-definition z-typeparameters z-begin z-ts">&lt;</span></span><span class="z-meta z-type z-parameters z-ts"><span class="z-entity z-name z-type z-ts">T</span><span class="z-punctuation z-separator z-comma z-ts">,</span> <span class="z-entity z-name z-type z-ts">Exclude</span><span class="z-meta z-type z-parameters z-ts"><span class="z-punctuation z-definition z-typeparameters z-begin z-ts">&lt;</span></span><span class="z-meta z-type z-parameters z-ts"><span class="z-keyword z-operator z-expression z-keyof z-ts">keyof</span> <span class="z-entity z-name z-type z-ts">T</span><span class="z-punctuation z-separator z-comma z-ts">,</span> <span class="z-entity z-name z-type z-ts">K</span></span><span class="z-meta z-type z-parameters z-ts"><span class="z-punctuation z-definition z-typeparameters z-end z-ts">&gt;</span></span></span><span class="z-meta z-type z-parameters z-ts"><span class="z-punctuation z-definition z-typeparameters z-end z-ts">&gt;</span></span></span><span class="z-punctuation z-terminator z-statement z-ts">;</span>

<span class="z-meta z-function z-ts"><span class="z-keyword z-control z-export z-ts">export</span> <span class="z-storage z-type z-function z-ts">function</span> <span class="z-meta z-definition z-function z-ts"><span class="z-entity z-name z-function z-ts">createEvent</span></span><span class="z-meta z-type z-parameters z-ts"><span class="z-punctuation z-definition z-typeparameters z-begin z-ts">&lt;</span><span class="z-entity z-name z-type z-ts">D</span> <span class="z-storage z-modifier z-ts">extends</span> <span class="z-entity z-name z-type z-ts">EventData</span><span class="z-punctuation z-definition z-typeparameters z-end z-ts">&gt;</span></span><span class="z-meta z-parameters z-ts"><span class="z-punctuation z-definition z-parameters z-begin z-ts">(</span>
  <span class="z-variable z-parameter z-ts">event_namespace</span><span class="z-meta z-type z-annotation z-ts"><span class="z-keyword z-operator z-type z-annotation z-ts">:</span> <span class="z-entity z-name z-type z-ts">D</span><span class="z-meta z-type z-tuple z-ts"><span class="z-meta z-brace z-square z-ts">[</span><span class="z-string z-quoted z-double z-ts"><span class="z-punctuation z-definition z-string z-begin z-ts">&quot;</span>event_namespace<span class="z-punctuation z-definition z-string z-end z-ts">&quot;</span></span><span class="z-meta z-brace z-square z-ts">]</span></span></span><span class="z-punctuation z-separator z-parameter z-ts">,</span>
  <span class="z-variable z-parameter z-ts">event_type</span><span class="z-meta z-type z-annotation z-ts"><span class="z-keyword z-operator z-type z-annotation z-ts">:</span> <span class="z-entity z-name z-type z-ts">D</span><span class="z-meta z-type z-tuple z-ts"><span class="z-meta z-brace z-square z-ts">[</span><span class="z-string z-quoted z-double z-ts"><span class="z-punctuation z-definition z-string z-begin z-ts">&quot;</span>event_type<span class="z-punctuation z-definition z-string z-end z-ts">&quot;</span></span><span class="z-meta z-brace z-square z-ts">]</span></span></span><span class="z-punctuation z-separator z-parameter z-ts">,</span>
  <span class="z-variable z-parameter z-ts">data</span><span class="z-meta z-type z-annotation z-ts"><span class="z-keyword z-operator z-type z-annotation z-ts">:</span> <span class="z-entity z-name z-type z-ts">Omit</span><span class="z-meta z-type z-parameters z-ts"><span class="z-punctuation z-definition z-typeparameters z-begin z-ts">&lt;</span></span><span class="z-meta z-type z-parameters z-ts"><span class="z-entity z-name z-type z-ts">D</span><span class="z-punctuation z-separator z-comma z-ts">,</span> <span class="z-string z-quoted z-double z-ts"><span class="z-punctuation z-definition z-string z-begin z-ts">&quot;</span>event_namespace<span class="z-punctuation z-definition z-string z-end z-ts">&quot;</span></span> <span class="z-keyword z-operator z-type z-ts">|</span> <span class="z-string z-quoted z-double z-ts"><span class="z-punctuation z-definition z-string z-begin z-ts">&quot;</span>event_type<span class="z-punctuation z-definition z-string z-end z-ts">&quot;</span></span> <span class="z-keyword z-operator z-type z-ts">|</span> <span class="z-string z-quoted z-double z-ts"><span class="z-punctuation z-definition z-string z-begin z-ts">&quot;</span>type<span class="z-punctuation z-definition z-string z-end z-ts">&quot;</span></span></span><span class="z-meta z-type z-parameters z-ts"><span class="z-punctuation z-definition z-typeparameters z-end z-ts">&gt;</span></span>
</span><span class="z-punctuation z-definition z-parameters z-end z-ts">)</span></span><span class="z-meta z-return z-type z-ts"><span class="z-keyword z-operator z-type z-annotation z-ts">:</span> <span class="z-entity z-name z-type z-ts">Event</span><span class="z-meta z-type z-parameters z-ts"><span class="z-punctuation z-definition z-typeparameters z-begin z-ts">&lt;</span></span><span class="z-meta z-type z-parameters z-ts"><span class="z-entity z-name z-type z-ts">D</span></span><span class="z-meta z-type z-parameters z-ts"><span class="z-punctuation z-definition z-typeparameters z-end z-ts">&gt;</span></span> </span><span class="z-meta z-block z-ts"><span class="z-punctuation z-definition z-block z-ts">{</span>
  <span class="z-keyword z-control z-flow z-ts">return</span><span class="z-meta z-objectliteral z-ts"> <span class="z-punctuation z-definition z-block z-ts">{</span>
    <span class="z-meta z-object z-member z-ts"><span class="z-meta z-object-literal z-key z-ts">id</span></span><span class="z-meta z-object z-member z-ts"><span class="z-meta z-object-literal z-key z-ts"><span class="z-punctuation z-separator z-key-value z-ts">:</span></span> <span class="z-meta z-function-call z-ts"><span class="z-entity z-name z-function z-ts">v4</span></span><span class="z-meta z-brace z-round z-ts">(</span><span class="z-meta z-brace z-round z-ts">)</span></span><span class="z-punctuation z-separator z-comma z-ts">,</span>
<span class="z-punctuation z-whitespace z-comment z-leading z-ts">    </span><span class="z-comment z-line z-double-slash z-ts"><span class="z-punctuation z-definition z-comment z-ts">//</span></span><span class="z-comment z-line z-double-slash z-ts"> Unsure why `as T` is required</span>
<span class="z-punctuation z-whitespace z-comment z-leading z-ts">    </span><span class="z-comment z-line z-double-slash z-ts"><span class="z-punctuation z-definition z-comment z-ts">//</span></span><span class="z-comment z-line z-double-slash z-ts"> but doesn&#39;t stop type checking working</span>
    <span class="z-meta z-object z-member z-ts"><span class="z-meta z-object-literal z-key z-ts">data</span></span><span class="z-meta z-object z-member z-ts"><span class="z-meta z-object-literal z-key z-ts"><span class="z-punctuation z-separator z-key-value z-ts">:</span></span> <span class="z-meta z-objectliteral z-ts"><span class="z-punctuation z-definition z-block z-ts">{</span>
      <span class="z-meta z-object z-member z-ts"><span class="z-keyword z-operator z-spread z-ts">...</span><span class="z-variable z-other z-readwrite z-ts">data</span></span><span class="z-punctuation z-separator z-comma z-ts">,</span>
      <span class="z-meta z-object z-member z-ts"><span class="z-meta z-object-literal z-key z-ts">type</span></span><span class="z-meta z-object z-member z-ts"><span class="z-meta z-object-literal z-key z-ts"><span class="z-punctuation z-separator z-key-value z-ts">:</span></span> <span class="z-string z-template z-ts"><span class="z-punctuation z-definition z-string z-template z-begin z-ts">`</span><span class="z-meta z-template z-expression z-ts"><span class="z-punctuation z-definition z-template-expression z-begin z-ts">${</span></span><span class="z-meta z-template z-expression z-ts"><span class="z-meta z-embedded z-line z-ts"><span class="z-variable z-other z-readwrite z-ts">event_namespace</span></span><span class="z-punctuation z-definition z-template-expression z-end z-ts">}</span></span>.<span class="z-meta z-template z-expression z-ts"><span class="z-punctuation z-definition z-template-expression z-begin z-ts">${</span></span><span class="z-meta z-template z-expression z-ts"><span class="z-meta z-embedded z-line z-ts"><span class="z-variable z-other z-readwrite z-ts">event_type</span></span><span class="z-punctuation z-definition z-template-expression z-end z-ts">}</span></span><span class="z-punctuation z-definition z-string z-template z-end z-ts">`</span></span></span><span class="z-punctuation z-separator z-comma z-ts">,</span>
      <span class="z-meta z-object z-member z-ts"><span class="z-variable z-other z-readwrite z-ts">event_type</span></span><span class="z-punctuation z-separator z-comma z-ts">,</span>
      <span class="z-meta z-object z-member z-ts"><span class="z-variable z-other z-readwrite z-ts">event_namespace</span></span><span class="z-punctuation z-separator z-comma z-ts">,</span>
    <span class="z-punctuation z-definition z-block z-ts">}</span></span> <span class="z-keyword z-control z-as z-ts">as</span> <span class="z-entity z-name z-type z-ts">D</span></span><span class="z-punctuation z-separator z-comma z-ts">,</span>
    <span class="z-meta z-object z-member z-ts"><span class="z-meta z-object-literal z-key z-ts">context</span></span><span class="z-meta z-object z-member z-ts"><span class="z-meta z-object-literal z-key z-ts"><span class="z-punctuation z-separator z-key-value z-ts">:</span></span> <span class="z-meta z-objectliteral z-ts"><span class="z-punctuation z-definition z-block z-ts">{</span>
      <span class="z-meta z-object z-member z-ts"><span class="z-meta z-object-literal z-key z-ts">time</span></span><span class="z-meta z-object z-member z-ts"><span class="z-meta z-object-literal z-key z-ts"><span class="z-punctuation z-separator z-key-value z-ts">:</span></span> <span class="z-new z-expr z-ts"><span class="z-keyword z-operator z-new z-ts">new</span> <span class="z-entity z-name z-type z-ts">Date</span><span class="z-meta z-brace z-round z-ts">(</span><span class="z-meta z-brace z-round z-ts">)</span></span><span class="z-meta z-function-call z-ts"><span class="z-punctuation z-accessor z-ts">.</span><span class="z-entity z-name z-function z-ts">toISOString</span></span><span class="z-meta z-brace z-round z-ts">(</span><span class="z-meta z-brace z-round z-ts">)</span></span><span class="z-punctuation z-separator z-comma z-ts">,</span>
    <span class="z-punctuation z-definition z-block z-ts">}</span></span></span><span class="z-punctuation z-separator z-comma z-ts">,</span>
  <span class="z-punctuation z-definition z-block z-ts">}</span></span><span class="z-punctuation z-terminator z-statement z-ts">;</span>
<span class="z-punctuation z-definition z-block z-ts">}</span></span></span>
</span></code></pre>
<p>Usage looks like this:</p>
<pre data-lang="typescript" class="language-typescript z-code"><code class="language-typescript" data-lang="typescript"><span class="z-source z-ts"><span class="z-meta z-var z-expr z-ts"><span class="z-storage z-type z-ts">const</span> <span class="z-meta z-var-single-variable z-expr z-ts"><span class="z-meta z-definition z-variable z-ts"><span class="z-variable z-other z-constant z-ts">emit_this</span></span> </span><span class="z-keyword z-operator z-assignment z-ts">=</span> <span class="z-meta z-function-call z-ts"><span class="z-entity z-name z-function z-ts">createEvent</span></span><span class="z-meta z-type z-parameters z-ts"><span class="z-punctuation z-definition z-typeparameters z-begin z-ts">&lt;</span><span class="z-entity z-name z-type z-ts">BlogEvent</span><span class="z-punctuation z-definition z-typeparameters z-end z-ts">&gt;</span></span><span class="z-meta z-brace z-round z-ts">(</span><span class="z-string z-quoted z-double z-ts"><span class="z-punctuation z-definition z-string z-begin z-ts">&quot;</span>some_namespace<span class="z-punctuation z-definition z-string z-end z-ts">&quot;</span></span><span class="z-punctuation z-separator z-comma z-ts">,</span> <span class="z-string z-quoted z-double z-ts"><span class="z-punctuation z-definition z-string z-begin z-ts">&quot;</span>SomeEventType<span class="z-punctuation z-definition z-string z-end z-ts">&quot;</span></span><span class="z-punctuation z-separator z-comma z-ts">,</span> <span class="z-meta z-objectliteral z-ts"><span class="z-punctuation z-definition z-block z-ts">{</span>
  <span class="z-meta z-object z-member z-ts"><span class="z-meta z-object-literal z-key z-ts">some_field</span></span><span class="z-meta z-object z-member z-ts"><span class="z-meta z-object-literal z-key z-ts"><span class="z-punctuation z-separator z-key-value z-ts">:</span></span> <span class="z-constant z-language z-boolean z-true z-ts">true</span></span><span class="z-punctuation z-separator z-comma z-ts">,</span>
  <span class="z-meta z-object z-member z-ts"><span class="z-meta z-object-literal z-key z-ts">some_other_field</span></span><span class="z-meta z-object z-member z-ts"><span class="z-meta z-object-literal z-key z-ts"><span class="z-punctuation z-separator z-key-value z-ts">:</span></span> <span class="z-constant z-numeric z-decimal z-ts">100</span></span><span class="z-punctuation z-separator z-comma z-ts">,</span>
<span class="z-punctuation z-definition z-block z-ts">}</span></span><span class="z-meta z-brace z-round z-ts">)</span></span><span class="z-punctuation z-terminator z-statement z-ts">;</span>
</span></code></pre>
<p>Nearly identical to before, save for adding <code>&lt;BlogEvent&gt;</code> to the call signature. Our ergonomics are
preserved, but now we get proper type checking! Any errors in any arguments will fail to compile.
For example:</p>
<pre data-lang="typescript" class="language-typescript z-code"><code class="language-typescript" data-lang="typescript"><span class="z-source z-ts"><span class="z-comment z-line z-double-slash z-ts"><span class="z-punctuation z-definition z-comment z-ts">//</span></span><span class="z-comment z-line z-double-slash z-ts"> Fails: typo in `SomeEventType`</span>
<span class="z-meta z-var z-expr z-ts"><span class="z-storage z-type z-ts">const</span> <span class="z-meta z-var-single-variable z-expr z-ts"><span class="z-meta z-definition z-variable z-ts"><span class="z-variable z-other z-constant z-ts">emit_this</span></span> </span><span class="z-keyword z-operator z-assignment z-ts">=</span> <span class="z-meta z-function-call z-ts"><span class="z-entity z-name z-function z-ts">createEvent</span></span><span class="z-meta z-type z-parameters z-ts"><span class="z-punctuation z-definition z-typeparameters z-begin z-ts">&lt;</span><span class="z-entity z-name z-type z-ts">BlogEvent</span><span class="z-punctuation z-definition z-typeparameters z-end z-ts">&gt;</span></span><span class="z-meta z-brace z-round z-ts">(</span><span class="z-string z-quoted z-double z-ts"><span class="z-punctuation z-definition z-string z-begin z-ts">&quot;</span>some_namespace<span class="z-punctuation z-definition z-string z-end z-ts">&quot;</span></span><span class="z-punctuation z-separator z-comma z-ts">,</span> <span class="z-string z-quoted z-double z-ts"><span class="z-punctuation z-definition z-string z-begin z-ts">&quot;</span>SomeEventTpr<span class="z-punctuation z-definition z-string z-end z-ts">&quot;</span></span><span class="z-punctuation z-separator z-comma z-ts">,</span> <span class="z-meta z-objectliteral z-ts"><span class="z-punctuation z-definition z-block z-ts">{</span>
  <span class="z-meta z-object z-member z-ts"><span class="z-meta z-object-literal z-key z-ts">some_field</span></span><span class="z-meta z-object z-member z-ts"><span class="z-meta z-object-literal z-key z-ts"><span class="z-punctuation z-separator z-key-value z-ts">:</span></span> <span class="z-constant z-language z-boolean z-true z-ts">true</span></span><span class="z-punctuation z-separator z-comma z-ts">,</span>
  <span class="z-meta z-object z-member z-ts"><span class="z-meta z-object-literal z-key z-ts">some_other_field</span></span><span class="z-meta z-object z-member z-ts"><span class="z-meta z-object-literal z-key z-ts"><span class="z-punctuation z-separator z-key-value z-ts">:</span></span> <span class="z-constant z-numeric z-decimal z-ts">100</span></span><span class="z-punctuation z-separator z-comma z-ts">,</span>
<span class="z-punctuation z-definition z-block z-ts">}</span></span><span class="z-meta z-brace z-round z-ts">)</span></span><span class="z-punctuation z-terminator z-statement z-ts">;</span>

<span class="z-comment z-line z-double-slash z-ts"><span class="z-punctuation z-definition z-comment z-ts">//</span></span><span class="z-comment z-line z-double-slash z-ts"> Fails: missing `some_other_field`</span>
<span class="z-meta z-var z-expr z-ts"><span class="z-storage z-type z-ts">const</span> <span class="z-meta z-var-single-variable z-expr z-ts"><span class="z-meta z-definition z-variable z-ts"><span class="z-variable z-other z-constant z-ts">emit_this</span></span> </span><span class="z-keyword z-operator z-assignment z-ts">=</span> <span class="z-meta z-function-call z-ts"><span class="z-entity z-name z-function z-ts">createEvent</span></span><span class="z-meta z-type z-parameters z-ts"><span class="z-punctuation z-definition z-typeparameters z-begin z-ts">&lt;</span><span class="z-entity z-name z-type z-ts">BlogEvent</span><span class="z-punctuation z-definition z-typeparameters z-end z-ts">&gt;</span></span><span class="z-meta z-brace z-round z-ts">(</span><span class="z-string z-quoted z-double z-ts"><span class="z-punctuation z-definition z-string z-begin z-ts">&quot;</span>some_namespace<span class="z-punctuation z-definition z-string z-end z-ts">&quot;</span></span><span class="z-punctuation z-separator z-comma z-ts">,</span> <span class="z-string z-quoted z-double z-ts"><span class="z-punctuation z-definition z-string z-begin z-ts">&quot;</span>SomeEventTpr<span class="z-punctuation z-definition z-string z-end z-ts">&quot;</span></span><span class="z-punctuation z-separator z-comma z-ts">,</span> <span class="z-meta z-objectliteral z-ts"><span class="z-punctuation z-definition z-block z-ts">{</span>
  <span class="z-meta z-object z-member z-ts"><span class="z-meta z-object-literal z-key z-ts">some_field</span></span><span class="z-meta z-object z-member z-ts"><span class="z-meta z-object-literal z-key z-ts"><span class="z-punctuation z-separator z-key-value z-ts">:</span></span> <span class="z-constant z-language z-boolean z-true z-ts">true</span></span><span class="z-punctuation z-separator z-comma z-ts">,</span>
<span class="z-punctuation z-definition z-block z-ts">}</span></span><span class="z-meta z-brace z-round z-ts">)</span></span><span class="z-punctuation z-terminator z-statement z-ts">;</span>
</span></code></pre>
<p>This code couples the power of generics with Typescripts weird (but quite pleasant)
string-literals-are-types feature to enforce that, given an event payload, the string arguments
given to <code>createEvent</code> <em>must</em> match whatever is defined for <code>BlogEvent</code>. The magic comes from using
the <a href="https://www.typescriptlang.org/docs/handbook/advanced-types.html"><strong>indexed access operator</strong></a>
(you'll have to search through that page to find it) <code>T[&quot;field_here&quot;]</code> syntax to match the string
literals, and some gymnastics to implement an <code>Omit</code> type. This type states, in plainer words, every
field in <code>D</code> <strong>except</strong> <code>type</code>, <code>event_namespace</code> and <code>event_type</code> must be present in the passed
object. This is good for the programmer - if they pass in those fields in the data object, they get
overwritten anyway, leading to unexpected behaviour. By denying them in the body, we enforce a more
correct, safer way of creating events.</p>
<p>The code isn't as elegant as just providing a type, but now it means that <strong>our function properly
type checks the resulting object</strong>. This means <strong>no more typoed event name fields</strong> and <strong>no more
missing/mis-spelled data fields</strong>! This inelegance can also be tucked away in some library code,
leaving just the nice interface. The only caveat with the above implementation that I've found so
far is that the programmer must explicitly provide the type, or typechecking won't be &quot;enabled&quot;.
There's a compiler option - <code>--noImplicitAny</code> - which might help with this but I haven't tried it
yet.</p>
<p>Typescript is <em>actually good</em> if you don't slap <code>any</code>s everywhere and leverage its type system
fully. People have a lot of strong opinions both ways about static type checking, but if it <em>stops
broken stuff getting into production</em>, then it absolutely should be another tool in your toolbox.</p>
</div>

  <footer role="contentinfo" class="footer">
  <a rel="me" href="https://mastodon.social/@jamwaffles">&nbsp;</a>

  <div class="inner">
    <div class="footer__bio">
      

      <div class="footer__bio__text">Personal blog of Rust developer and hobby CNC machinist James Waples. Living in Edinburgh, Scotland 🏴󠁧󠁢󠁳󠁣󠁴󠁿 ❤️</div>
    </div>

    <div class="footer__links">
      <a href="https:&#x2F;&#x2F;wapl.es">James Waples&#x27; Internet Hole</a>

      <a
        href="/atom.xml"
        id="btn_feed"
        class="btn"
        title="Feed"
        target="_blank"
      >
        <span aria-hidden="true" data-icon=")"></span>
        <strong>RSS Feed</strong>
      </a>

      <span>Published with <a href="https://www.getzola.org">Zola</a></span>
    </div>
  </div>
</footer>

</article>


    

    <script
      data-goatcounter="https://jamwaffles.goatcounter.com/count"
      async
      src="//gc.zgo.at/count.js"
    ></script>
  </body>
</html>
